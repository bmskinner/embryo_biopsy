---
title: "Embryo Mosaicism"
output: 
  html_document:
    number_sections: true
    toc_float: true
    toc_collapsed: false
    toc_levels: 4
    toc: true
    theme: united
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE, warning=FALSE, echo=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(tessera)
library(plotly)
library(ggplot2)
library(animation)
library(parallel)

biopsy.delta = 19 # plus or minus aneuploidy percent
n.replicate.seeds = 50
n.cores = ifelse(Sys.info()["sysname"]=="Windows", 1, 20) # parallel only works on Unix-like
```


```{r functions, echo=F, warning=F, message=F, warning=F}

# Define functions

plot.embryo = function(e){
  # just show the state of the chromosome of interest
  colours = factor(as.integer(bitwAnd(e$isAneuploid,1)),
                   levels = c(0, 1))
  
  plot_ly( type="scatter3d",
           mode="markers",
           colors = c("#22FF22", "#111111"),
           color=colours,
           hoverinfo="none") %>%
    add_trace(
      x = e$x,
      y = e$y,
      z = e$z,
      marker = list(
        colors = c("#22FF22", "#111111"),
        line = list(
          color = '111111',
          width = 1
        )
      ),
      showlegend = F
    ) %>%
    add_annotations( text="Click and drag to rotate the chart",
                     xref="paper", yref="paper",
                     x=0.0, xanchor="left",
                     y=1.0, yanchor="top",
                     legendtitle=TRUE, showarrow=FALSE ) %>%
    layout(scene = list(xaxis = list(fixedrange = TRUE, showgrid = F), 
                        yaxis = list(fixedrange = TRUE, showgrid = F),
                        zaxis = list(fixedrange = TRUE, showgrid = F))) %>%
    config(displayModeBar = FALSE)
}

# Plot the biopsy results
plot.biopsy.aneuploidy = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  biopsy.data = as.data.frame(pct.biopsy.aneuploid) %>%
    dplyr::group_by(pct.biopsy.aneuploid) %>%
    dplyr::summarise(n = dplyr::n()) %>%
    dplyr::mutate(PctBiopsies = n/sum(n)*100)
  
  # Number of biopsies
  ggplot(biopsy.data, aes(x=pct.biopsy.aneuploid, y = PctBiopsies)) +
    geom_col(width = 1) +
    coord_cartesian(xlim = c(0, 100), 
                    ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 20)) +
    scale_y_continuous(breaks = seq(0, 100, 10)) + 
    labs(x = "Percent aneuploid cells in biopsy",
         y = "Percent of biopsies from this embryo") +
    theme_classic()
}

# Calculate the percentage of biopsies within the accuracy window, greater or
# less. Window size is given by biopsy.delta
calc.rates = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  equal.rate = sum(  pct.biopsy.aneuploid>pct.embryo.aneuploid-biopsy.delta &
                       pct.biopsy.aneuploid<pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  lower.rate = sum(pct.biopsy.aneuploid<=pct.embryo.aneuploid-biopsy.delta)/length(pct.biopsy.aneuploid)*100
  higher.rate = sum(pct.biopsy.aneuploid>=pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  list("equal" = equal.rate, "lower" = lower.rate, "higher" = higher.rate)
}

# A weighted measure that considers how far each biopsy is from the true value
calculate.difference = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  # max.diff = 100 # worst result possible
  # calculate sum of squares and normalise to number of biopsies
  # sum.diffs = sum((pct.biopsy.aneuploid-pct.embryo.aneuploid)**2)
  # sum.diffs/length(pct.biopsy.aneuploid)
  vals = abs(pct.biopsy.aneuploid-pct.embryo.aneuploid)
  list("mean" = mean(vals), "sd" = sd(vals), "values" = vals)
}

plot.step =  function(result, variable.name, variable.values){
  input = data.frame(variable = result[,1],
                      accuracy = result[,2])

  all.vals = expand.grid("variable" = variable.values,
                         "accuracy" = c(sort(unique(round(result[,2]))), 100),
                         "Count" = 0)
  
  n.cells = (input %>% dplyr::group_by(variable) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::select(Count) %>%
    dplyr::distinct())$Count
  
  data = invisible(input %>% 
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    rbind(., all.vals) %>%
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = sum(Count))) %>%
    dplyr::mutate(Pct = Count/n.cells*100) %>%
    dplyr::arrange(variable, accuracy) %>%
    dplyr::group_by(variable) %>%
    dplyr::mutate(CumPct = cumsum(Pct))
  
  
  ggplot(data, aes(x = accuracy, y = CumPct, group = variable, col = variable)) + 
    geom_step(size = 2) +
    labs(y = "Cumulative percentage of biopsies",
         x = "Percent difference between biopsy and embryo",
         col = variable.name) + 
    scale_color_viridis_c() + 
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 10)) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    theme_classic()
}

```

# Introduction

Tessera is able to simulate a sphere with cells placed evenly around the surface. Biopsies can be taked from the sphere. This can be used as a toy embryo to explore the effects of changing parameters: the number of cells in the embryo, the proportion of aneuploid cells, the dispersion of aneuploid cells and the size of the biopsy.

We are interested in understanding the limits of what an embryo biopsy can tell us, since a biopsy may not be informative if embryos can be mosaic. 

What are the impacts of changing the distribution of aneuploid cells within the embryo? If some cells are tightly clumped, and others are more dispersed, how is the biopsy outcome affected?

What is the impact of changing the biopsy to take a variable number of cells (i.e. + or - n around the desired number. Does the outcome differ from the fixed sample size?

Finally, if we are given a biopsy, what can we actually conclude about the embryo from whence it came?

# Changing the embryo parameters

In the first stage of the model, we alter the embryo parameters to find the effect these have on the biopsy we will observe.

## The dispersal of aneuploid cells affects the relevance of a biopsy result

We start by creating a single embryo of 200 cells, with a 20% aneuploidy rate (40 aneuploid cells). The aneuploid cells are highly dispersed throughout the embryo; it is unlikely, though not impossible, that two aneuploid cells will be adjacent.

```{r, echo=F, warning=F}
e = tessera::create.embryo(n.cells = 200, 
                           prop.aneuploids = 0.2, 
                           dispersions = 1, 
                           concordance = 1, seed = 44)

plot.embryo(e)

```

Now to explore the possible biopsies from this embryo. We will take 5-cell biopsies, starting at each cell in turn. This reveals the range of possible biopsies we could obtain.

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 20)
rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

We see that around half of the biopsies have the same 20% aneuploidy rate as the embryo. In this case, with a 5-cell biopsy, a single aneuploid cell within the biopsy gives us a perfect match to the embryo aneuploidy rate. This may not be the case if the aneuploidy rate changes.

We need a measure that can capture the overall accuracy of the biopsy. This can be calculated from the difference between each biopsy and the true aneuploidy rate. We take the mean difference between the percentage aneuploidy for each biopsy and the embryo. This measure yields an mean difference of `r acc[["mean"]]` percent for the embryo above, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%.

Now contrast this with an embryo that has the same aneuploidy rate of 20%, but with low dispersal of the aneuploid cells. Now it is very likely that an aneuploid cell has another aneuploid cell adjacent:

```{r, echo=F, warning=F, fig.cap="Embryo with highly clustered aneuploid cells"}
e = tessera::create.embryo(n.cells = 200, 
                           prop.aneuploids = 0.2, 
                           dispersions = 0, 
                           concordance = 1, seed = 42)

plot.embryo(e)

```

The aneuploid cells are in a discrete patch in the embryo, and the distribution of possible 5-cell biopsies changes:

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 0.2)

rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

The accuracy score for this embryo is `r acc[["mean"]]`, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%. 

We can now show how accuracy varies as we increase the aneuploidy level from 0% to 100%:

```{r, echo=F, warning=F, message=F, cache=T, fig.cap="Accuracy is lowest when half the embryo is aneuploid"}
make.aneuploidy.plot = function(aneuploidy){
  e = tessera::create.embryo(n.cells = 200, 
                             prop.aneuploids = aneuploidy, 
                             dispersions = 0, 
                             concordance = 1, seed = 42)
  b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)
  acc = calculate.difference(b, 5, aneuploidy*100)
  p  = plot.biopsy.aneuploidy(b, 5, aneuploidy*100)
  p + geom_vline(xintercept = aneuploidy*100) + 
    geom_text(x=75, y=95, label=paste(aneuploidy*100, "% aneuploid cells:\n", 
                                      sprintf(acc[["mean"]], fmt = '%#.2f'), 
                                      "mean percent difference\nSD:", 
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  
}

invisible(animation::saveGIF(
  expr = { for(i in seq(0, 1, 0.05)) plot(make.aneuploidy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Aneuploidy.gif"
))
knitr::include_graphics("Aneuploidy.gif")
```

These bar plots are useful, but we are cycling through animations. Another way to represent this data is through cumulative plots of embryo accuracy. Here we show the effect of increasing embryo aneuploidy from 0% to 50% (omitting 50%-100% because they roughly mirror the former):

```{r, echo=FALSE, cache=T, fig.cap="Embryos with high dispersal of aneuploid cells"}

aneuploidies = seq(0, 0.5, 0.1)
result = do.call(rbind, mclapply(aneuploidies, function(prop.aneuploid){
  
  e = tessera::create.embryo(n.cells = 200,
                             prop.aneuploids = prop.aneuploid,
                             dispersions = 1,
                             concordance = 1, seed = 44)
  b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)
  acc = calculate.difference(b, 5, prop.aneuploid*100)
  
  
  cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy = round(acc[["values"]]))
}, mc.cores = n.cores))

plot.step(result, "Aneuploidy", aneuploidies)
```
The distribution becomes a little clearer; we can see that at 50% aneuploidy, all embryos have at least a 10% difference to the embryo. The maximum difference between an embryo and any biopsy is 50 percentage points.

## The accuracy of the biopsy varies with the dispersal of aneuploid cells

The accuracy varies with dispersal as follows:

```{r, echo=F, warning=F, message=F, cache=T}
make.dispersal.plot = function(dispersal){
  e = tessera::create.embryo(n.cells = 200, 
                           prop.aneuploids = 0.2, 
                           dispersions = dispersal, 
                           concordance = 1, seed = 42)
  b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  p  = plot.biopsy.aneuploidy(b, 5, 20)
  p + geom_vline(xintercept = 20) + 
    geom_text(x=75, y=95, label=paste(dispersal*100, "% dispersal of cells:\n", 
                                        sprintf(acc[["mean"]], fmt = '%#.2f'), 
                                      "mean percent difference\nSD:", 
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  
}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal.gif"
))
knitr::include_graphics("Dispersal.gif")
```

We see that changing the dispersal of the aneuploid cells also impacts the biopsies we will get, even if the total number of aneuploid cells remains constant. When aneuploid cells are highly clustered, the difference is about 25%, dropping to about 10% when cells are dispersed. 

```{r, echo=FALSE, cache=T, fig.cap="Lower dispersal of cells reduces biopsy accuracy"}
dispersals = seq(0, 1, 0.05)
result = do.call(rbind, mclapply(dispersals, function(dispersal){
  
  e = tessera::create.embryo(n.cells = 200, 
                             prop.aneuploids = 0.2, 
                             dispersions = dispersal, 
                             concordance = 1, seed = 44)
  b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  
  cbind(dispersal = rep(dispersal, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, mc.cores = n.cores))

plot.step(result, "Dispersal", dispersals)
```

Consequently, with an aneuploidy rate of 20% in the embryo, a biopsy reaches on average within 10% of the true aneuploidy at best. Notably, this accuracy would only be found with repeated biopsying of the same embryo, which cannot happen in reality.

## Accuracy of a biopsy also depends on the rate of aneuploidy in the embryo

Below, we show the effect of increasing dispersal from low to high.

```{r, echo=FALSE, message=F, warning=F, cache=T, fig.cap="Embryos with varying dispersal of aneuploid cells"}

make.dispersal.aneuploidy.plot = function(dispersal){
  aneuploidies = seq(0, 0.5, 0.05)
  result = do.call(rbind, mclapply(aneuploidies, function(prop.aneuploid){

    e = tessera::create.embryo(n.cells = 200,
                               prop.aneuploids = prop.aneuploid,
                               dispersions = dispersal,
                               concordance = 1, seed = 44)
    b = tessera::take.all.biopsies(e, n.cells.per.sample = 5, chromosome = 1)
    acc = calculate.difference(b, 5, prop.aneuploid*100)
    

    cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, mc.cores = n.cores))
  
  plot.step(result, "Aneuploidy", aneuploidies) + 
    geom_text(x=75, y=75, label=paste("Dispersal:", dispersal), col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.aneuploidy.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal_aneuploidy.gif"
))
knitr::include_graphics("Dispersal_aneuploidy.gif")

```

Dispersal has a much greater impact on the biopsy results than overall aneuploidy level.

# Changing the biopsy parameters

So far we have varied the parameters of the embryo, keeping the biopsy size constant. What happens if we change the biopsy instead?

### Accuracy depends on the size of the biopsy relative to the embryo

How does the distribution of aneuploid cells in a biopsy change as the size of the biopsy increases? The following animation shows the effect of increasing biopsy size from 1 to 10 cells in an embryo of 200 cells.

```{r, echo=FALSE, warning=F, message=F, cache=T}
e = tessera::create.embryo(n.cells = 200, 
                           prop.aneuploids = 0.2, 
                           dispersions = 1, 
                           concordance = 1, seed = 42)


make.biopsy.plot = function(biopsy){
  b = tessera::take.all.biopsies(e, n.cells.per.sample = biopsy, chromosome = 1)
  acc = calculate.difference(b, biopsy, 20)
  p  = plot.biopsy.aneuploidy(b, biopsy, 20)
  p + geom_vline(xintercept = 20) + 
    geom_text(x=75, y=95, label=paste(biopsy, "cell biopsy:\n", 
                                        sprintf(acc[['mean']], fmt = '%#.2f'), 
                                        "mean percent difference\nSD:", 
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  
}

invisible(animation::saveGIF(
  expr = { for(i in 1:10) plot(make.biopsy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Biopsy_size.gif"
))
knitr::include_graphics("Biopsy_size.gif")
```


Converting the absolute number of cells into a fraction of the embryo size, we get the following:

```{r, eval=T, echo=FALSE, cache=T, fig.cap="Sampling more than 5% of the embryo is not more informative in most cases"}

samples = seq(0.005, 0.15, 0.005)

result = do.call(rbind, mclapply(samples, function(fraction.of.embryo.in.biopsy){
  biopsy.size = fraction.of.embryo.in.biopsy * 200
  
  e = tessera::create.embryo(n.cells = 200,
                             prop.aneuploids = 0.2,
                             dispersions = 1,
                             concordance = 1, seed = 44)
  b = tessera::take.all.biopsies(e, n.cells.per.sample = biopsy.size, chromosome = 1)
  acc = calculate.difference(b, biopsy.size, 20)
  
  
  cbind(anuploidy = rep(fraction.of.embryo.in.biopsy, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, mc.cores = n.cores))

plot.step(result, "Biopsy fraction", samples)

```

It appears that there is little benefit to increasing the biopsy size to more than ~5% of the embryo size. The chart above is from an embryo with 200 cells and 20% aneuploidy, highly dispersed. How does the accuracy vary as embryo size changes from 100-300 cells?
 
```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T}

embryo.sizes = seq(100, 300, 20)
biopsy.fractions = seq(0.005, 0.15, 0.005)

make.biopsy.size.plot = function(embryo.size){

  result = do.call(rbind, mclapply(biopsy.fractions, function(biopsy.fraction){
    # Constrain biopsy to between 1 and embryo size
    biopsy.size = round(min(max(1, biopsy.fraction * embryo.size), embryo.size))

    # Make embryo of the desired size
    e = tessera::create.embryo(n.cells = embryo.size,
                               prop.aneuploids = 0.2,
                               dispersions = 1,
                               concordance = 1, seed = 44)
    b = tessera::take.all.biopsies(e, n.cells.per.sample = biopsy.size, chromosome = 1)
    acc = calculate.difference(b, biopsy.size, 20)

    cbind(fraction = rep(biopsy.fraction, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, mc.cores = n.cores))
  
  plot.step(result, "Biopsy fraction", biopsy.fractions) + 
    geom_text(x = 75, y = 75, 
              label = paste("Embryo:", embryo.size, "cells"), 
              col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in embryo.sizes) plot(make.biopsy.size.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Embryo_size_v_biopsy_size.gif"
))
knitr::include_graphics("Embryo_size_v_biopsy_size.gif")

```

It is clear that the overall size of the embryo has little effect compared to the biopsy size, and as we saw above there are few benefits to increasing biopsy size to more than 5% of the embryo size.

# What does a biopsy tell us?

From the previous sections, we have seen that the parameters of the toy embryo and the biopsy affect how well the biopsy represents the embryo. Now, we shall consider what we can conclude from a given biopsy. We will assume that both the size of the embryo and the size of the biopsy are known, and we do not know the aneuploidy level or the dispersion of the aneuploid cells. If we are given a biopsy, what range of embryo parameters are compatible?

