---
title: "Tessera: a tool to visualise embryo mosaicism"
always_allow_html: true
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_levels: 4
    highlight: tango
  # bookdown::word_document2:
  #   toc: true
  #   fig_width: 9
  #   number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, echo=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(tessera)
library(magrittr)
library(plotly)
library(ggplot2)
library(animation)
library(parallel)
library(patchwork)
library(htmlwidgets)

biopsy.delta = 19
n.cores = ifelse(Sys.info()["sysname"]=="Windows", 1, 20) # parallel only works on Unix-like

pgdis.classes = factor(c("Euploid", "Low level", "High level", "Aneuploid"), 
                       levels = c("Euploid", "Low level", "High level", "Aneuploid"))
```


```{r functions, echo=F, warning=F, message=F, warning=F}

# Define functions

# Plot the biopsy results
plot.biopsy.aneuploidy = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  biopsy.data = as.data.frame(pct.biopsy.aneuploid) %>%
    dplyr::group_by(pct.biopsy.aneuploid) %>%
    dplyr::summarise(n = dplyr::n()) %>%
    dplyr::mutate(PctBiopsies = n/sum(n)*100)
  
  # Number of biopsies
  ggplot(biopsy.data, aes(x=pct.biopsy.aneuploid, y = PctBiopsies)) +
    geom_col(width = 1) +
    coord_cartesian(xlim = c(0, 100), 
                    ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 20)) +
    scale_y_continuous(breaks = seq(0, 100, 10)) + 
    labs(x = "Percent aneuploid cells in biopsy",
         y = "Percent of biopsies from this embryo") +
    theme_classic()
}

# Calculate the percentage of biopsies within the accuracy window, greater or
# less. Window size is given by biopsy.delta
calc.rates = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  equal.rate = sum(  pct.biopsy.aneuploid>pct.embryo.aneuploid-biopsy.delta &
                       pct.biopsy.aneuploid<pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  lower.rate = sum(pct.biopsy.aneuploid<=pct.embryo.aneuploid-biopsy.delta)/length(pct.biopsy.aneuploid)*100
  higher.rate = sum(pct.biopsy.aneuploid>=pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  list("equal" = equal.rate, "lower" = lower.rate, "higher" = higher.rate)
}

# A weighted measure that considers how far each biopsy is from the true value
calculate.difference = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  # max.diff = 100 # worst result possible
  # calculate sum of squares and normalise to number of biopsies
  # sum.diffs = sum((pct.biopsy.aneuploid-pct.embryo.aneuploid)**2)
  # sum.diffs/length(pct.biopsy.aneuploid)
  vals = abs(pct.biopsy.aneuploid-pct.embryo.aneuploid)
  list("mean" = mean(vals), "sd" = sd(vals), "values" = vals)
}

# Create a step chart
plot.step =  function(result, variable.name, variable.values){
  input = data.frame(variable = result[,1],
                      accuracy = result[,2])

  all.vals = expand.grid("variable" = variable.values,
                         "accuracy" = as.numeric(c(sort(unique(round(result[,2]))), 100)),
                         "Count" = 0)
  
  n.cells = (input %>% dplyr::group_by(variable) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::select(Count) %>%
    dplyr::distinct())$Count
  
  data = suppressMessages(input %>% 
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::bind_rows(., all.vals) %>%
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = sum(Count)) %>%
    dplyr::mutate(Pct = Count/n.cells*100) %>%
    dplyr::arrange(variable, accuracy) %>%
    dplyr::group_by(variable) %>%
    dplyr::mutate(CumPct = cumsum(Pct)))
  
      # print(str(data))
  ggplot(data, aes(x = accuracy, y = CumPct, group = variable, col = variable)) +
    geom_step(size = 2) +
    labs(y = "Cumulative percentage of biopsies",
         x = "Percent difference between biopsy and embryo",
         col = variable.name) +
    scale_color_viridis_c() +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 10)) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    theme_classic()
}

to.pgdis.class = function(pct.aneuploidy){
  if(pct.aneuploidy<20) return("Euploid")
  if(pct.aneuploidy<40) return("Low level")
  if(pct.aneuploidy<80) return("High level")
  return("Aneuploid")
}

pgdis.accuracy = function(n.aneuploid, biopsy.size, actual.aneuploidy.pct){
  d = n.aneuploid/biopsy.size * 100
  
  actual.class = to.pgdis.class(actual.aneuploidy.pct)
  
  result = as.data.frame(d)
  result$Class = sapply(result$d, to.pgdis.class)
  
  (result %>% dplyr::group_by(Class) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::mutate(Pct = Count / length(d) * 100) %>%
    dplyr::filter(Class == actual.class))$Pct
}


plot.pgdis = function(n.aneuploid, biopsy.size){
  
  d = n.aneuploid/biopsy.size *100
  result = as.data.frame(d)
  result$Class = sapply(result$d, to.pgdis.class)
  result = result %>% dplyr::group_by(Class) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::mutate(Pct = Count / length(d) * 100)
  
  ggplot(result, aes(x = Class, y = Pct )) +
    geom_col() + 
    lims(x = pgdis.classes) + 
    labs(x = "PGDIS classification",
         y = "Percent of biopsies from embryo") + 
    coord_cartesian(ylim = c(0, 100)) + 
    scale_y_continuous(breaks = seq(0, 100, 10)) +
    theme_classic()
}

```

# Introduction

Trophectoderm biopsy is an increasinly used method for assessing aneuploidy in pre-implantation embryos (PGT-A). These embryos are usually 150-200 cells, from which a 5-10 cell biopsy is taken. With the discovery that embryos at this stage can be mosaic, there is a question as to the utility of the biopsy; will a biopsy be informative as to the embryo state?

We have developed Tessera, a tool to simulate a sphere with cells placed evenly around the surface. Biopsies can be taked from the sphere. This can be used as a toy embryo to explore the effects of changing parameters: the number of cells in the embryo, the proportion of aneuploid cells, the dispersion of aneuploid cells and the size of the biopsy.

We are interested in understanding the limits of what an embryo biopsy can tell us. What are the impacts of changing the distribution of aneuploid cells within the embryo? If some cells are tightly clumped, and others are more dispersed, how is the biopsy outcome affected? How does the size of the biopsy affect the accuracy of the result?

Finally, if we are given a biopsy, what can we actually conclude about the embryo from whence it came?

# Changing the embryo parameters

In the first stage of the model, we alter the embryo parameters to find the effect these have on the biopsy we will observe.

## Creating a model embryo

We start by creating a single embryo of 200 cells, with a 20% aneuploidy rate (40 aneuploid cells). The aneuploid cells are highly dispersed throughout the embryo; it is unlikely, though not impossible, that two aneuploid cells will be adjacent.

```{r, echo=F, warning=F, fig.show="hold", fig.cap="Example 200 cell embryo with 20% aneuploidy, dispersed"}
e = tessera::Embryo(n.cells = 200, 
                    n.chrs = 1,
                    prop.aneuploid = 0.2, 
                    dispersal = 1, 
                    concordance = 1, 
                    rng.seed = 44)


plot(e)

# # Save viewer settings (e.g. RStudio viewer pane)
# op <- options()
# 
# # Set viewer to web browser
# options(viewer = NULL)
# 
# # Use web browser to save image
# plot.embryo(e) %>% htmlwidgets::onRender(
#   "function(el, x) {
#   var gd = document.getElementById(el.id); 
#   Plotly.downloadImage(gd, {format: 'png', width: 720, height: 480, filename: 'e1'});
#   }"
#  )
# 
# # Restore viewer to old setting (e.g. RStudio)
# options(viewer = op$viewer)

# knitr::include_graphics("e1.png")

```

Now to explore the possible biopsies from this embryo. We will take 5-cell biopsies, starting at each cell in turn. A biopsy is composed of the starting cell and its four closest neighbours. This reveals the range of possible biopsies we could obtain.

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 20)
rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

We see that around half of the biopsies have the same 20% aneuploidy rate as the embryo. In this case, with a 5-cell biopsy, a single aneuploid cell within the biopsy gives us a perfect match to the embryo aneuploidy rate. This may not be the case if the aneuploidy rate changes.

We need a measure that can capture the overall accuracy of the biopsy. This can be calculated from the difference between each biopsy and the true aneuploidy rate. We take the mean difference between the percentage aneuploidy for each biopsy and the embryo. This measure yields an mean difference of `r acc[["mean"]]` percent for the embryo above, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%.

Now contrast this with an embryo that has the same aneuploidy rate of 20%, but with low dispersal of the aneuploid cells. Now it is very likely that an aneuploid cell has another aneuploid cell adjacent:

```{r, echo=F, warning=F, fig.show="hold", fig.cap="Example 200 cell embryo with 20% aneuploidy, clustered"}
e = tessera::Embryo(n.cells = 200, 
                    n.chrs = 1,
                    prop.aneuploid = 0.2, 
                    dispersal = 0, 
                    concordance = 1, 
                    rng.seed = 42)

plot(e)
# knitr::include_graphics("e2.png")

```

The aneuploid cells are in a discrete patch in the embryo, and the distribution of possible 5-cell biopsies changes:

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 0.2)

rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

The accuracy score for this embryo is `r acc[["mean"]]`, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%. 

## The effect of aneuploidy level on biopsy results

We can now show how accuracy varies as we increase the aneuploidy level from 0% to 100%:

```{r, echo=F, warning=F, message=F, cache=T, fig.show = 'hold', fig.cap="Accuracy is lowest when half the embryo is aneuploid (animated gif)"}
make.aneuploidy.plot = function(aneuploidy){
  e = tessera::Embryo(n.cells = 200,
                    n.chrs = 1,
                    prop.aneuploid = aneuploidy,
                    dispersal = 0,
                    concordance = 1,
                    rng.seed = 42)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, aneuploidy*100)
  p  = plot.biopsy.aneuploidy(b, 5, aneuploidy*100)
  p + geom_vline(xintercept = aneuploidy*100) +
    geom_text(x=75, y=95, label=paste(aneuploidy*100, "% aneuploid cells:\n",
                                      sprintf(acc[["mean"]], fmt = '%#.2f'),
                                      "mean percent difference\nSD:",
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))

}

invisible(animation::saveGIF(
  expr = { for(i in seq(0, 1, 0.05)) plot(make.aneuploidy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Aneuploidy.gif"
))
knitr::include_graphics("Aneuploidy.gif")
```

The bar plots above are useful, but we would cycle through several plots to see the impact of altering a single variable. Another way to represent this data is through cumulative plots of embryo accuracy. Here we show the effect of increasing embryo aneuploidy from 0% to 50% (omitting 50%-100% because they roughly mirror the former). Higher values to the left are better:

```{r, echo=FALSE, cache=T, fig.show='hold', fig.cap="Embryos with high dispersal of aneuploid cells"}

aneuploidies = seq(0, 0.5, 0.1)
result = do.call(rbind, mclapply(aneuploidies, function(prop.aneuploid){
  
  e = tessera::Embryo(n.cells = 200,
                      n.chrs = 1,
                      prop.aneuploid = prop.aneuploid,
                      dispersal = 1,
                      concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, prop.aneuploid*100)
  
  
  cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy = round(acc[["values"]]))
}, mc.cores = n.cores))

plot.step(result, "Aneuploidy", aneuploidies)
```

The distribution becomes a little clearer; we can see that at 50% aneuploidy, no biopsies exactly match the embryo; 65% of biopsies have at least a 10% difference to the embryo. Translating this back to cells: since the biopsy is 5 cells a 10% difference from 50% embryo aneuploidy means either 40% of the biopsy is aneuploid (2 cells) or 60% of the biopsy is aneuploid (3 cells). 95% of biopsies have _at least_ a 30% difference to the embryo.

## Aneuploidy with respect to PGDIS classification thresholds

So far we have been simulating a range of embryo parameters and biopsy outcomes without consideration of how these will be interpreted in the clinic. According to guidelines of the Preimplantation Genetic Diagnosis International Society (PGDIS), a blastocyst will be considered euploid if there are less than 20% aneuploid cells. Aneuploidy of 20%-40% is considered low level mosaic, 40%-80% high level mosaic, and above 80% is aneuploid (Gleicher et al., 2020; Munné et al. 2020).

Using these criteria, how accurate would our diaganoses be given a randomly sampled 5-cell biopsy from an embryo with 10% aneuploidy or 50% aneuploidy and high dispersal?

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classes for embryos with 10% (euploid) and 50% aneuploidy (high-level) demonstrate the difference in accuracy from changing aneuploidy level" }

e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.1,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)


e2 = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.5,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
b2 = tessera::takeAllBiopsies(e2, biopsy.size = 5, chromosome = 1)


plot.pgdis(b, 5) + plot.pgdis(b2, 5)

```

We can see that at 10% aneuploidy, a little over half the biopsies match the embryo classification. At 50% aneuploidy, 67% of embryos match the embryo classification. Accuracy varies with aneuploidy as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classification accuracy by aneuploidy level" }


result = sapply(seq(0.0, 1, 0.05), function(aneuploidy){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = aneuploidy,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  pgdis.accuracy(b, 5, aneuploidy*100)
})

result = as.data.frame(cbind(accuracy = result, aneuploidy = seq(0, 100, 5)))

ggplot(result, aes(x = aneuploidy, y = accuracy)) +
  geom_col() + 
  labs(x = "Percentage aneuploidy in embryo",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  theme_classic()

```


## The effect of dispersal on biopsy results

We return to an embryo with 200 cells, and a fixed 20% aneuploidy. We can now vary the dispersal of the aneuploid cells within the embryo. The accuracy varies with dispersal as follows.

```{r, echo=F, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Biopsy accuracy is higher when aneuploid cells are dispersed  (animated gif)"}
make.dispersal.plot = function(dispersal){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.2,
                           dispersal = dispersal,
                           concordance = 1, rng.seed = 42)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  p  = plot.biopsy.aneuploidy(b, 5, 20)
  p + geom_vline(xintercept = 20) +
    geom_text(x=75, y=95, label=paste(dispersal*100, "% dispersal of cells:\n",
                                        sprintf(acc[["mean"]], fmt = '%#.2f'),
                                      "mean percent difference\nSD:",
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))

}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal.gif"
))
knitr::include_graphics("Dispersal.gif")
```

We see that changing the dispersal of the aneuploid cells also impacts the biopsies we will get, even if the total number of aneuploid cells remains constant. However, the variation appears to be less than that seen in the aneuploidy data above.

```{r, echo=FALSE, cache=T, fig.show='hold', fig.cap="Lower dispersal of cells reduces biopsy accuracy"}
dispersals = seq(0, 1, 0.05)
result = do.call(rbind, mclapply(dispersals, function(dispersal){
  
  e = tessera::Embryo(n.cells = 200, 
                             prop.aneuploid = 0.2, 
                             dispersal = dispersal, 
                             concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  
  cbind(dispersal = rep(dispersal, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, mc.cores = n.cores))

plot.step(result, "Dispersal", dispersals)
```

To confirm this, we show below the effect of increasing dispersal from low to high over a range of aneuploidies.

```{r, echo=FALSE, message=F, warning=F, cache=T, fig.show='hold', fig.cap="Embryos with varying dispersal of aneuploid cells  (animated gif)"}

make.dispersal.aneuploidy.plot = function(dispersal){
  aneuploidies = seq(0, 0.5, 0.05)
  result = do.call(rbind, mclapply(aneuploidies, function(prop.aneuploid){

    e = tessera::Embryo(n.cells = 200,
                               prop.aneuploid = prop.aneuploid,
                               dispersal = dispersal,
                               concordance = 1, rng.seed = 44)
    b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
    acc = calculate.difference(b, 5, prop.aneuploid*100)
    

    cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, mc.cores = n.cores))
  
  plot.step(result, "Aneuploidy", aneuploidies) + 
    geom_text(x=75, y=75, label=paste("Dispersal:", dispersal), col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.aneuploidy.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal_aneuploidy.gif"
))
knitr::include_graphics("Dispersal_aneuploidy.gif")

```

At low aneuploidy levels, dispersal has a much greater impact on the biopsy results than aneuploidy level, but as aneuploidy rises, dispersal becomes less important in the accuracy of the biopsy.

## Dispersal with respect to PGDIS classification thresholds

Using these criteria, how accurate would our diaganoses be given a randomly sampled 5-cell biopsy from an embryo with 10% aneuploidy and low or high dispersal?

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classes for embryos with 10% aneuploidy (euploid) with low and high dispersal demonstrate the difference in accuracy from changing dispersal" }

e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.1,
                           dispersal = 0,
                           concordance = 1, rng.seed = 44)
b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)


e2 = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.1,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
b2 = tessera::takeAllBiopsies(e2, biopsy.size = 5, chromosome = 1)


plot.pgdis(b, 5) + plot.pgdis(b2, 5)

```

We see that dispersal has a significant impact on biopsy results, with clustered aneuploid cells more likely to be classified accurately. The full range of dispersals for an embryo with 10% aneuploidy is as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classification accuracy by dispersion level" }


result = sapply(seq(0.0, 1, 0.05), function(dispersal){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.1,
                           dispersal = dispersal,
                           concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  pgdis.accuracy(b, 5, 10)
})

result = as.data.frame(cbind(accuracy = result, dispersal = seq(0, 1, 0.05)))

ggplot(result, aes(x = dispersal, y = accuracy)) +
  geom_col() + 
  labs(x = "Dispersal of aneuploid cells",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 1, 0.1)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  coord_cartesian(ylim = c(0, 100)) +
  theme_classic()

```

Interestingly, the interaction between aneuploidy level and dispersal reveals that PGDIS classification accuracy is dramatically affected by low dispersal, but only for intermediate levels of aneuploidy.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classification accuracy by aneuploidy and dispersion level" }

combinations = expand.grid(aneuploidies = seq(0, 1, 0.1),
                           dispersals   = seq(0, 1, 0.1))

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        accuracy   = pgdis.accuracy(b, 5, aneuploidy * 100))
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
SIMPLIFY = F))

ggplot(as.data.frame(result), aes(x = aneuploidy*100, y = dispersal, fill = accuracy)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0, 100, 20)) +
  labs(x = "Percent aneuploidy in embryo", 
       y = "Dispersal of aneuploid cells",
       fill = "Percentage\nof accurate\nPGDIS\nclassifications") + 
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  theme_classic()
```

# Changing the biopsy parameters

So far we have varied the parameters of the embryo, keeping the biopsy size constant. What happens if we change the biopsy instead?

## The effect of changing biopsy size

How does the distribution of aneuploid cells in a biopsy change as the size of the biopsy increases? The following animation shows the effect of increasing biopsy size from 1 to 10 cells in an embryo of 200 cells.

```{r, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Biopsy size affects accuracy  (animated gif)"}
e = tessera::Embryo(n.cells = 200, 
                           prop.aneuploid = 0.2, 
                           dispersal = 1, 
                           concordance = 1, rng.seed = 42)


make.biopsy.plot = function(biopsy){
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy, chromosome = 1)
  acc = calculate.difference(b, biopsy, 20)
  p  = plot.biopsy.aneuploidy(b, biopsy, 20)
  p + geom_vline(xintercept = 20) + 
    geom_text(x=75, y=95, label=paste(biopsy, "cell biopsy:\n", 
                                        sprintf(acc[['mean']], fmt = '%#.2f'), 
                                        "mean percent difference\nSD:", 
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  
}

invisible(animation::saveGIF(
  expr = { for(i in 1:10) plot(make.biopsy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Biopsy_size.gif"
))
knitr::include_graphics("Biopsy_size.gif")
```


Converting the absolute number of cells into a fraction of the embryo size, we get the following:

```{r, eval=T, echo=FALSE, cache=T, fig.show='hold', fig.cap="Biopsy size does not drastically affect the accuracy of the biopsy beyond about 5% of the embryo"}

samples = seq(3, 31, 1)

result = do.call(rbind, mclapply(samples, function(fraction.of.embryo.in.biopsy){
  biopsy.size = fraction.of.embryo.in.biopsy
  
  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = 0.2,
                             dispersal = 1,
                             concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
  acc = calculate.difference(b, biopsy.size, 20)
  
  
  cbind(anuploidy = rep(biopsy.size, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, mc.cores = n.cores))

plot.step(result, "Biopsy size", samples)


```

We can focus on just two biopsy sizes, 5 cells and 10 cells:

```{r, eval=T, echo=FALSE, cache=T, fig.show='hold', fig.cap="Changing biopsy size from 5 to 10 cells does not dramatically improve accuracy"}

# Filter to just 5 and 10 cell biopsies in 200 cell embryo
# Note that the biopsy size is in the column called aneuploidy
# for compatibility with plot.step

filt = result[result[,1]==5 | result[,1]==10,]
plot.step(filt, "Biopsy size", c(5, 10))

```

It appears that there is little benefit to increasing the biopsy size to more than ~5% of the embryo size. The chart above is from an embryo with 200 cells and 20% aneuploidy, highly dispersed. How does the accuracy vary as embryo size changes from 100-300 cells?
 
```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Sampling more than 5% of the embryo is not more informative regardless of embryo size  (animated gif)"}

embryo.sizes = seq(100, 300, 20)
biopsy.fractions = seq(0.005, 0.15, 0.005)

make.biopsy.size.plot = function(embryo.size){

  result = do.call(rbind, mclapply(biopsy.fractions, function(biopsy.fraction){
    # Constrain biopsy to between 1 and embryo size
    biopsy.size = round(min(max(1, biopsy.fraction * embryo.size), embryo.size))

    # Make embryo of the desired size
    e = tessera::Embryo(n.cells = embryo.size,
                               prop.aneuploid = 0.2,
                               dispersal = 1,
                               concordance = 1, rng.seed = 44)
    b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
    acc = calculate.difference(b, biopsy.size, 20)

    cbind(fraction = rep(biopsy.fraction, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, mc.cores = n.cores))
  
  plot.step(result, "Biopsy fraction", biopsy.fractions) + 
    geom_text(x = 75, y = 75, 
              label = paste("Embryo:", embryo.size, "cells"), 
              col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in embryo.sizes) plot(make.biopsy.size.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Embryo_size_v_biopsy_size.gif"
))
knitr::include_graphics("Embryo_size_v_biopsy_size.gif")

```

It is clear that the overall size of the embryo has little effect compared to the biopsy size, and as we saw above there are few benefits to increasing biopsy size to more than 5-10 cells of the embryo size.

## Biopsy size with respect to PGDIS classification thresholds

We can now explore the impact of biopsy size on the PGDIS classifictions. We start by looking at a 200 cell embryo with 20% aneuploidy and high dispersal.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Biopsy size affects the accuracy of PGDIS classification" }


result = sapply(seq(3, 50, 1), function(biopsy.size){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.2,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
  pgdis.accuracy(b, biopsy.size, 20)
})

result = as.data.frame(cbind(accuracy = result, biopsy.size = seq(3, 50, 1)))

ggplot(result, aes(x = biopsy.size, y = accuracy)) +
  geom_col() + 
  labs(x = "Size of biopsy",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 50, 5)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  coord_cartesian(ylim = c(0, 100)) +
  theme_classic()

```

These data are noisy, with a repeating pattern every 5 cells due to the hard boundaries of the PGDIS classifiation scheme. We see though that there is little to no benefit in sampling more than 5-10 cells from an embryo.

# What does a biopsy tell us?

From the previous sections, we have seen that the parameters of the toy embryo and the biopsy affect how well the biopsy represents the embryo. Now, we shall consider what we can conclude from a given biopsy. We will assume that both the size of the embryo and the size of the biopsy are known, and we do not know the aneuploidy level or the dispersion of the aneuploid cells. If we are given a biopsy, what range of embryo parameters are compatible?

## Predicting an embryo state from a biopsy

We return to a fixed biopsy size of 5 cells. This biopsy has a single aneuploid cell, a rate of 20%. We know the embryo has 200 cells. What are the possible parameters for aneuploidy and dispersal?


```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T}

combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05))

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
SIMPLIFY = F))



# Determine the proportion of conditions with the same outcome as our test biopsy
output.aneuploidy = as.data.frame(result) %>%
  dplyr::group_by(n.aneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = dplyr::n())
  
# this gives us the overall accuracy: we will accuratly assess the aneuploidy level
# in x percent of biopsies:
overall.accuracy.0 = sum(output.aneuploidy[output.aneuploidy$n.aneuploid==1,]$Count)/nrow(result)*100

```

If we define `r nrow(combinations)` embryos with all combinations of aneuploidy (`r length(unique(combinations$aneuploidies))` steps from 0-1) and dispersal (`r length(unique(combinations$dispersals))` steps from 0-1), we can take `r nrow(result)` possible biopsies across the resulting embryos. Our biopsy has 1 aneuploid cell; this pattern is seen in `r sprintf(overall.accuracy.0, fmt = '%#.2f')`% of the total biopsies:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Number of biopsies across all embryos with aneuploid cells"}
ggplot(as.data.frame(result), aes(x = n.aneuploid, fill = n.aneuploid==1)) + 
  geom_bar() + 
  labs(x = "Number of aneuploid cells in biopsy",
       y = "Number of possible biopsies from all embryo combinations") + 
  scale_x_continuous(breaks = seq(0, 5, 1)) +
  scale_fill_manual(values = c("grey", "blue")) + 
  theme_classic() + 
  theme(legend.position = "none")

```

We can now look at the possible embryos that could yield this biopsy. The biopsies with a single aneuploid cell come from embryos with the following parameters:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Possible embryo parameters matching a biopsy with one aneuploid cell"}

zero.data = expand.grid(aneuploidy = combinations$aneuploidies,
                          dispersal  = combinations$dispersals,
                          n.aneuploid = 0:5,
                          Count = 0)

matching.biopsies = suppressMessages(output.aneuploidy %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(aneuploidy, dispersal, n.aneuploid) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(n.aneuploid) %>%
  dplyr::mutate(Total = sum(Count)) %>%
  dplyr::mutate(Pct = Count / Total * 100))

ggplot(matching.biopsies %>% dplyr::filter(n.aneuploid==1), aes(x=aneuploidy, y=dispersal, fill=Pct)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0.1, 1.1, 0.2)) +
  labs(x = "Aneuploidy", 
       y = "Dispersal",
       fill = "Percentage\nof biopsies") + 
  theme_classic()

```

We see that while a biopsy like this most probably comes from an embryo with 20% aneuploidy and high dispersal, there is a wide range of possibilities. A similar probability space can be created for any number of observed aneuploid cells:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="The probability space of 5-cell biopsies for a 200 cell embryo"}

ggplot(matching.biopsies, aes(x=aneuploidy, y=dispersal, fill=Pct)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0.1, 1.1, 0.2)) +
  labs(x = "Aneuploidy", 
       y = "Dispersal",
       fill = "Percentage\nof biopsies") + 
  theme_classic() +
  facet_wrap(~n.aneuploid)

```

As noted above, we see that the dispersal of cells only becomes relevant at low levels; above 25% dispersal, the results are broadly similar across all biopsies.

## Predicting PGDIS classifiction from a biopsy

From the above, we can now determine the percentage of PGDIS classes that a given biopsy could originate from. We see that there is about a 50% chance that the biopsy came from a low level embryo, and about a 25% chance each that the embryo came from a euploid or high level embryo.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Liklihood of each PGDIS class producing a 5-cell biopsy with a single aneuploid cell" }


combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05))

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = 44)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
SIMPLIFY = F)) %>% as.data.frame

result$PctBiopsyAneuploid = result$n.aneuploid / 5 * 100
result$EmbryoClass = factor(sapply(result$aneuploidy*100, to.pgdis.class), 
                            levels = pgdis.classes)


# Now take the biopsies with a single aneuploid cell

# Determine the proportion of conditions with the same outcome as our test biopsy
output.aneuploidy = result %>%
  dplyr::group_by(n.aneuploid, EmbryoClass) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(n.aneuploid) %>%
  dplyr::mutate(Total = sum(Count)) %>%
  dplyr::mutate(PctTotal = Count / Total * 100)
  
ggplot(output.aneuploidy%>%dplyr::filter(n.aneuploid==1), aes(x = EmbryoClass, y = PctTotal)) + 
  geom_col() + 
  geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.2f'), y = PctTotal-5), col="white") + 
  labs(y = "Percent of biopsies") +
  coord_cartesian(ylim = c(0, 50)) + 
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  theme_classic() + 
  theme(axis.title.x = element_blank())
```

We can also show the probability of origins for biopsies for the full range of 0-5 aneuploid cells:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Liklihood of each PGDIS class producing a 5-cell biopsy with a given number of aneuploid cells", fig.height=7 }

ggplot(output.aneuploidy, aes(x = EmbryoClass, y = PctTotal)) + 
  geom_col() + 
  geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.2f'), y = PctTotal-5), col = "white") + 
  labs(y = "Percent of biopsies from this class") +
  coord_cartesian(ylim = c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  facet_wrap(~n.aneuploid, ncol = 2) + 
  theme_classic() + 
  theme(axis.title.x = element_blank())
```

We can conclude from this that although there are limitations to biopsies, a 5-cell biopsy of a 200 cell embryo is able to give a useful indication as to the true level of aneuploidy of the embryo when aneuploidy is low or high. This can be visualised more clearly as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Confidently relating biopsy aneuploidy to embryo aneuploidy is only possible if dispersal is high" }

zero.data = expand.grid(aneuploidy = seq(0, 1, 0.05),
                        PctBiopsyAneuploid  = seq(0, 100, 20),
                        Count = 0)

clumpy.embryos = result %>% dplyr::filter(dispersal == 0) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid) %>%
  dplyr::mutate(CountBiopsy = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::mutate(PctTotal = Count/CountBiopsy * 100, dispersal = 0 )

dispersed.embryos = result %>% dplyr::filter(dispersal == 1) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid) %>%
  dplyr::mutate(CountBiopsy = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy) %>%
  dplyr::mutate(PctTotal = Count/CountBiopsy * 100, dispersal = 1 )

both.embryos = rbind(dispersed.embryos, clumpy.embryos)

ggplot(both.embryos, aes(x = PctBiopsyAneuploid, y = aneuploidy, fill=PctTotal))+
  geom_tile() +
  # geom_text(label = clumpy.embryos$PctTotal) +
  scale_fill_viridis_c(breaks = seq(0, 30, 5)) +
  labs(x = "Biopsy aneuploidy",
       y = "Embryo aneuploidy",
       fill = "Percentage\nof biopsies") +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  theme_classic() + 
  facet_wrap(~dispersal)
```

When aneuploid cells are dispersed, there is a clear correlation between the aneuploidy in the biopsy and the aneuploidy in the embryo. However, if aneuploid cells are clustered, there is no clear correlation, and we cannot infer the embryo aneuploidy except in cases when there is 0% or 100% aneuploidy.

# Can we improve biopsy usefulness with multiple biopsies?

We have seen that biopsies are not informative except when they are entirely euploid or aneuploid. We have also seen that increasing the biopsy size from 5 cells to 10 cells provides little extra information. What if we instead take two separate 5-cell biopsies, that could be from different regions of the embryo? Does this provide us with better information?



# Caveats and limitations

This is clearly a simple model using a toy embryo. The predictive power is limited by several factors:

- we assume that all combinations of aneuploidy and dispersal are equally likely. This may not be true of real embryos, and the parameter space may need to be refined
- we assume that the size of the embryo and biopsy are known and fixed. It is possible for a biopsy to contain more or fewer cells than desired, and is can be unclear exactly how many cells the embryo contains
 
 The next question to consider is that of biological relevance; where in the parameter space can embryos actually lie? Do embryos with high dispersal exist, or are they always found with clusters of aneuploidy?
 
 
 It would be expeccted that dispersal is generally clustered, with aneuploid cells resulting from an initial non-disjunction event. However cases of multiple independent aneuploidies have been noted (e.g. Mendiola et al 2022).
 
# TODO
 
 - run the simulations over a several embryos for each parameter combination
 - develop reverse lookup tool in tessera

