---
title: "Tessera: a tool to visualise embryo mosaicism"
always_allow_html: true
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_levels: 4
    highlight: tango
  # bookdown::word_document2:
  #   toc: true
  #   fig_width: 9
  #   number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, echo=F, message=F}
knitr::opts_chunk$set(echo = TRUE)
library(tessera)
library(magrittr)
library(plotly)
library(ggplot2)
library(animation)
library(parallel)
library(patchwork)
library(htmlwidgets)

biopsy.delta = 19
n.replicates = 50
n.cores = ifelse(Sys.info()["sysname"]=="Windows", 1, 20) # parallel only works on Unix-like

pgdis.classes = factor(c("Euploid", "Low level", "High level", "Aneuploid"), 
                       levels = c("Euploid", "Low level", "High level", "Aneuploid"))

# Define functions

# Plot the biopsy results
plot.biopsy.aneuploidy = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  biopsy.data = as.data.frame(pct.biopsy.aneuploid) %>%
    dplyr::group_by(pct.biopsy.aneuploid) %>%
    dplyr::summarise(n = dplyr::n()) %>%
    dplyr::mutate(PctBiopsies = n/sum(n)*100)
  
  # Number of biopsies
  ggplot(biopsy.data, aes(x=pct.biopsy.aneuploid, y = PctBiopsies)) +
    geom_col(width = 1) +
    coord_cartesian(xlim = c(0, 100), 
                    ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 20)) +
    scale_y_continuous(breaks = seq(0, 100, 10)) + 
    labs(x = "Percent aneuploid cells in biopsy",
         y = "Percent of biopsies from this embryo") +
    theme_classic()
}

# Calculate the percentage of biopsies within the accuracy window, greater or
# less. Window size is given by biopsy.delta
calc.rates = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  equal.rate = sum(  pct.biopsy.aneuploid>pct.embryo.aneuploid-biopsy.delta &
                       pct.biopsy.aneuploid<pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  lower.rate = sum(pct.biopsy.aneuploid<=pct.embryo.aneuploid-biopsy.delta)/length(pct.biopsy.aneuploid)*100
  higher.rate = sum(pct.biopsy.aneuploid>=pct.embryo.aneuploid+biopsy.delta)/length(pct.biopsy.aneuploid)*100
  list("equal" = equal.rate, "lower" = lower.rate, "higher" = higher.rate)
}

# A weighted measure that considers how far each biopsy is from the true value
calculate.difference = function(n.biopsy.aneuploid, biopsy.size, pct.embryo.aneuploid){
  pct.biopsy.aneuploid = n.biopsy.aneuploid / biopsy.size * 100
  # max.diff = 100 # worst result possible
  # calculate sum of squares and normalise to number of biopsies
  # sum.diffs = sum((pct.biopsy.aneuploid-pct.embryo.aneuploid)**2)
  # sum.diffs/length(pct.biopsy.aneuploid)
  vals = abs(pct.biopsy.aneuploid-pct.embryo.aneuploid)
  list("mean" = mean(vals), "sd" = sd(vals), "values" = vals)
}

# Create a step chart
plot.step =  function(result, variable.name, variable.values){
  input = data.frame(variable = result[,1],
                      accuracy = result[,2])

  all.vals = expand.grid("variable" = variable.values,
                         "accuracy" = as.numeric(c(sort(unique(round(result[,2]))), 100)),
                         "Count" = 0)
  
  n.cells = (input %>% dplyr::group_by(variable) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::select(Count) %>%
    dplyr::distinct())$Count
  
  data = suppressMessages(input %>% 
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::bind_rows(., all.vals) %>%
    dplyr::group_by(variable, accuracy) %>%
    dplyr::summarise(Count = sum(Count)) %>%
    dplyr::mutate(Pct = Count/n.cells*100) %>%
    dplyr::arrange(variable, accuracy) %>%
    dplyr::group_by(variable) %>%
    dplyr::mutate(CumPct = cumsum(Pct)))
  
      # print(str(data))
  ggplot(data, aes(x = accuracy, y = CumPct, group = variable, col = variable)) +
    geom_step(size = 2) +
    labs(y = "Cumulative percentage of biopsies",
         x = "Percent difference between biopsy and embryo",
         col = variable.name) +
    scale_color_viridis_c() +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100)) +
    scale_x_continuous(breaks = seq(0, 100, 10)) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    theme_classic()
}

to.pgdis.class = function(pct.aneuploidy){
  if(pct.aneuploidy<20) return("Euploid")
  if(pct.aneuploidy<40) return("Low level")
  if(pct.aneuploidy<80) return("High level")
  return("Aneuploid")
}

pgdis.accuracy = function(n.aneuploid, biopsy.size, actual.aneuploidy.pct){
  d = n.aneuploid/biopsy.size * 100
  
  actual.class = to.pgdis.class(actual.aneuploidy.pct)
  
  result = as.data.frame(d)
  result$Class = sapply(result$d, to.pgdis.class)
  
  (result %>% dplyr::group_by(Class) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::mutate(Pct = Count / length(d) * 100) %>%
    dplyr::filter(Class == actual.class))$Pct
}


plot.pgdis = function(n.aneuploid, biopsy.size){
  
  d = n.aneuploid/biopsy.size *100
  result = as.data.frame(d)
  result$Class = sapply(result$d, to.pgdis.class)
  result = result %>% dplyr::group_by(Class) %>%
    dplyr::summarise(Count = dplyr::n()) %>%
    dplyr::mutate(Pct = Count / length(d) * 100)
  
  ggplot(result, aes(x = Class, y = Pct )) +
    geom_col() + 
    lims(x = pgdis.classes) + 
    labs(x = "PGDIS classification",
         y = "Percent of biopsies from embryo") + 
    coord_cartesian(ylim = c(0, 100)) + 
    scale_y_continuous(breaks = seq(0, 100, 10)) +
    theme_classic()
}

```

# Introduction

Trophectoderm biopsy is an increasinly used method for assessing aneuploidy in pre-implantation embryos (PGT-A). These embryos are usually 150-200 cells, from which a 5-10 cell biopsy is taken. With the discovery that embryos at this stage can be mosaic, there is a question as to the utility of the biopsy; will a biopsy be informative as to the embryo state?

We have developed Tessera, a tool to simulate a sphere with cells placed evenly around the surface. Biopsies can be taked from the sphere. This can be used as a toy embryo to explore the effects of changing parameters: the number of cells in the embryo, the proportion of aneuploid cells, the dispersion of aneuploid cells and the size of the biopsy.

We are interested in understanding the limits of what an embryo biopsy can tell us. What are the impacts of changing the distribution of aneuploid cells within the embryo? If some cells are tightly clumped, and others are more dispersed, how is the biopsy outcome affected? How does the size of the biopsy affect the accuracy of the result?

Finally, if we are given a biopsy, what can we actually conclude about the embryo from whence it came?

# Changing the embryo parameters

In the first stage of the model, we alter the embryo parameters to find the effect these have on the biopsy we will observe.

## Creating a model embryo

We start by creating a single embryo of 200 cells, with a 20% aneuploidy rate (40 aneuploid cells). The aneuploid cells are highly dispersed throughout the embryo; it is unlikely, though not impossible, that two aneuploid cells will be adjacent.

```{r, echo=F, warning=F, fig.show="hold", fig.cap="Example 200 cell embryo with 20% aneuploidy, dispersed"}
e = tessera::Embryo(n.cells = 200, 
                    n.chrs = 1,
                    prop.aneuploid = 0.2, 
                    dispersal = 1, 
                    concordance = 1, 
                    rng.seed = 44)


plot(e)

# # Save viewer settings (e.g. RStudio viewer pane)
# op <- options()
# 
# # Set viewer to web browser
# options(viewer = NULL)
# 
# # Use web browser to save image
# plot.embryo(e) %>% htmlwidgets::onRender(
#   "function(el, x) {
#   var gd = document.getElementById(el.id); 
#   Plotly.downloadImage(gd, {format: 'png', width: 720, height: 480, filename: 'e1'});
#   }"
#  )
# 
# # Restore viewer to old setting (e.g. RStudio)
# options(viewer = op$viewer)

# knitr::include_graphics("e1.png")

```

Now to explore the possible biopsies from this embryo. We will take 5-cell biopsies, starting at each cell in turn. A biopsy is composed of the starting cell and its four closest neighbours. This reveals the range of possible biopsies we could obtain.

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 20)
rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

We see that around half of the biopsies have the same 20% aneuploidy rate as the embryo. In this case, with a 5-cell biopsy, a single aneuploid cell within the biopsy gives us a perfect match to the embryo aneuploidy rate. This may not be the case if the aneuploidy rate changes.

We need a measure that can capture the overall accuracy of the biopsy. This can be calculated from the difference between each biopsy and the true aneuploidy rate. We take the mean difference between the percentage aneuploidy for each biopsy and the embryo. This measure yields an mean difference of `r acc[["mean"]]` percent for the embryo above, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%.

Now contrast this with an embryo that has the same aneuploidy rate of 20%, but with low dispersal of the aneuploid cells. Now it is very likely that an aneuploid cell has another aneuploid cell adjacent:

```{r, echo=F, warning=F, fig.show="hold", fig.cap="Example 200 cell embryo with 20% aneuploidy, clustered"}
e = tessera::Embryo(n.cells = 200, 
                    n.chrs = 1,
                    prop.aneuploid = 0.2, 
                    dispersal = 0, 
                    concordance = 1, 
                    rng.seed = 42)

plot(e)
# knitr::include_graphics("e2.png")

```

The aneuploid cells are in a discrete patch in the embryo, and the distribution of possible 5-cell biopsies changes:

```{r, echo=F, fig.cap="Percentage of aneuploid cells in each biopsy"}

b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)

plot.biopsy.aneuploidy(b, 5, 0.2)

rates = calc.rates(b, 5, 20)
acc = calculate.difference(b, 5, 20)
```

The accuracy score for this embryo is `r acc[["mean"]]`, with a standard deviation of `r sprintf(acc[["sd"]], fmt = '%#.2f')`%. 

## The effect of aneuploidy level on biopsy results

We can now show how accuracy varies as we increase the aneuploidy level from 0% to 100%:

```{r, echo=F, warning=F, message=F, cache=T, fig.show = 'hold', fig.cap="Accuracy is lowest when half the embryo is aneuploid (animated gif)"}
make.aneuploidy.plot = function(aneuploidy){
  e = tessera::Embryo(n.cells = 200,
                    n.chrs = 1,
                    prop.aneuploid = aneuploidy,
                    dispersal = 0,
                    concordance = 1,
                    rng.seed = 42)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, aneuploidy*100)
  p  = plot.biopsy.aneuploidy(b, 5, aneuploidy*100)
  p + geom_vline(xintercept = aneuploidy*100) +
    geom_text(x=75, y=95, label=paste(aneuploidy*100, "% aneuploid cells:\n",
                                      sprintf(acc[["mean"]], fmt = '%#.2f'),
                                      "mean percent difference\nSD:",
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))

}

invisible(animation::saveGIF(
  expr = { for(i in seq(0, 1, 0.05)) plot(make.aneuploidy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Aneuploidy.gif"
))
knitr::include_graphics("Aneuploidy.gif")
```

The bar plots above are useful, but we would cycle through several plots to see the impact of altering a single variable. Another way to represent this data is through cumulative plots of embryo accuracy. Here we show the effect of increasing embryo aneuploidy from 0% to 50% (omitting 50%-100% because they roughly mirror the former). Higher values to the left are better:

```{r, echo=FALSE, cache=T, fig.show='hold', fig.cap="Embryos with high dispersal of aneuploid cells"}

# aneuploidies = seq(0, 0.5, 0.1)
# result = do.call(rbind, mclapply(aneuploidies, function(prop.aneuploid){
#   
#   e = tessera::Embryo(n.cells = 200,
#                       n.chrs = 1,
#                       prop.aneuploid = prop.aneuploid,
#                       dispersal = 1,
#                       concordance = 1, rng.seed = 44)
#   b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
#   acc = calculate.difference(b, 5, prop.aneuploid*100)
#   
#   
#   cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
#         accuracy = round(acc[["values"]]))
# }, mc.cores = n.cores))
# 
# plot.step(result, "Aneuploidy", aneuploidies)

combinations = expand.grid(aneuploidies = seq(0, 0.5, 0.1),
                           seeds = 1:n.replicates)

result = do.call(rbind, mcmapply(function(prop.aneuploid, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      n.chrs = 1,
                      prop.aneuploid = prop.aneuploid,
                      dispersal = 1,
                      concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, prop.aneuploid*100)
  
  
  cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy  = round(acc[["values"]]))
}, prop.aneuploid = combinations$aneuploidies, seed = combinations$seeds, 
mc.cores = n.cores, SIMPLIFY = F))

plot.step(result, "Aneuploidy", seq(0, 0.5, 0.1))
```

The distribution becomes a little clearer; we can see that at 50% aneuploidy, no biopsies exactly match the embryo; 65% of biopsies have at least a 10% difference to the embryo. Translating this back to cells: since the biopsy is 5 cells a 10% difference from 50% embryo aneuploidy means either 40% of the biopsy is aneuploid (2 cells) or 60% of the biopsy is aneuploid (3 cells). 95% of biopsies have _at most_ a 30% difference to the embryo.

## Aneuploidy with respect to PGDIS classification thresholds

So far we have been simulating a range of embryo parameters and biopsy outcomes without consideration of how these will be interpreted in the clinic. According to guidelines of the Preimplantation Genetic Diagnosis International Society (PGDIS), a blastocyst will be considered euploid if there are less than 20% aneuploid cells. Aneuploidy of 20%-40% is considered low level mosaic, 40%-80% high level mosaic, and above 80% is aneuploid (Gleicher et al., 2020; MunnÃ© et al. 2020).

Using these criteria, how accurate would our diaganoses be given a randomly sampled 5-cell biopsy from an embryo with 10% aneuploidy or 50% aneuploidy and high dispersal?

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classes for embryos with A) 10% (euploid) and B) 50% aneuploidy (high-level) demonstrate the difference in accuracy from changing aneuploidy level" }

b = c()
for(s in 1:n.replicates){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.1,
                           dispersal = 1,
                           concordance = 1, rng.seed = s)
  b = c(b, tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1))
}

b2 = c()

for(s in 1:n.replicates){
  e2 = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.5,
                           dispersal = 1,
                           concordance = 1, rng.seed = s)
  b2 = c(b2, tessera::takeAllBiopsies(e2, biopsy.size = 5, chromosome = 1))
}


plot.pgdis(b, 5) + plot.pgdis(b2, 5) + plot_annotation(tag_levels = c("A"))

```

We can see that at 10% aneuploidy, a little over half the biopsies match the embryo classification. At 50% aneuploidy, 67% of embryos match the embryo classification. Accuracy varies with aneuploidy as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height=3, fig.cap=paste("PGDIS classification accuracy by aneuploidy level. Error bars show standard deviation across", n.replicates, "replicates") }


combinations = expand.grid(aneuploidies = seq(0.0, 1, 0.05),
                           seeds = 1:n.replicates)

result = do.call(rbind, mcmapply(function(prop.aneuploid, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = prop.aneuploid,
                      dispersal = 1,
                      concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(prop.aneuploid*100, length(b)), 
        accuracy   = pgdis.accuracy(b, 5, prop.aneuploid*100))

}, prop.aneuploid = combinations$aneuploidies, seed = combinations$seeds, 
mc.cores = n.cores, SIMPLIFY = F)) %>% 
  as.data.frame %>%
  dplyr::group_by(aneuploidy) %>%
  dplyr::summarise(sd = sd(accuracy), accuracy = mean(accuracy) )

ggplot(result, aes(x = aneuploidy, y = accuracy)) +
  geom_col() + 
  geom_errorbar(ymin = result$accuracy - result$sd, 
                ymax = result$accuracy + result$sd,
                width = 2.5) +
  labs(x = "Percentage aneuploidy in embryo",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  theme_classic()

```


## The effect of dispersal on biopsy results

We return to an embryo with 200 cells, and a fixed 20% aneuploidy. We can now vary the dispersal of the aneuploid cells within the embryo. The accuracy varies with dispersal as follows.

```{r, echo=F, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Biopsy accuracy is higher when aneuploid cells are dispersed  (animated gif)"}
make.dispersal.plot = function(dispersal){
  e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.2,
                           dispersal = dispersal,
                           concordance = 1, rng.seed = 42)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  p  = plot.biopsy.aneuploidy(b, 5, 20)
  p + geom_vline(xintercept = 20) +
    geom_text(x=75, y=95, label=paste(dispersal*100, "% dispersal of cells:\n",
                                        sprintf(acc[["mean"]], fmt = '%#.2f'),
                                      "mean percent difference\nSD:",
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))

}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal.gif"
))
knitr::include_graphics("Dispersal.gif")
```

We see that changing the dispersal of the aneuploid cells also impacts the biopsies we will get, even if the total number of aneuploid cells remains constant. However, the variation appears to be less than that seen in the aneuploidy data above.

```{r, echo=FALSE, cache=T, fig.show='hold', fig.cap="Lower dispersal of cells reduces biopsy accuracy"}

combinations = expand.grid(dispersals = seq(0, 1, 0.05),
                           seeds = 1:n.replicates)

result = do.call(rbind, mcmapply(function(dispersal, seed){
  
   e = tessera::Embryo(n.cells = 200, 
                             prop.aneuploid = 0.2, 
                             dispersal = dispersal, 
                             concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  acc = calculate.difference(b, 5, 20)
  
  cbind(dispersal = rep(dispersal, length(acc[["values"]])), 
        accuracy  = acc[["values"]])

}, dispersal = combinations$dispersals, seed = combinations$seeds, 
mc.cores = n.cores, SIMPLIFY = F))

plot.step(result, "Dispersal", combinations$dispersals)
```

To confirm this, we show below the effect of increasing dispersal from low to high over a range of aneuploidies.

```{r, echo=FALSE, message=F, warning=F, cache=T, fig.show='hold', fig.cap="Embryos with varying dispersal of aneuploid cells  (animated gif)"}

make.dispersal.aneuploidy.plot = function(dispersal){
  
  combinations = expand.grid(aneuploidies = seq(0, 0.5, 0.05),
                             seeds = 1:n.replicates)
  
  result = do.call(rbind, mcmapply(function(prop.aneuploid, seed){

    e = tessera::Embryo(n.cells = 200,
                               prop.aneuploid = prop.aneuploid,
                               dispersal = dispersal,
                               concordance = 1, rng.seed = seed)
    b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
    acc = calculate.difference(b, 5, prop.aneuploid*100)
    
    cbind(anuploidy = rep(prop.aneuploid, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, mc.cores = n.cores,
  prop.aneuploid = combinations$aneuploidies, seed = combinations$seeds,
  SIMPLIFY = F))
  
  plot.step(result, "Aneuploidy", combinations$aneuploidies) + 
    geom_text(x=75, y=75, label=paste("Dispersal:", dispersal), col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in seq(0, 1, 0.05)) plot(make.dispersal.aneuploidy.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Dispersal_aneuploidy.gif"
))
knitr::include_graphics("Dispersal_aneuploidy.gif")

```

At low aneuploidy levels, dispersal has a much greater impact on the biopsy results than aneuploidy level, but as aneuploidy rises, dispersal becomes less important in the accuracy of the biopsy.

## Dispersal with respect to PGDIS classification thresholds

Using these criteria, how accurate would our diaganoses be given a randomly sampled 5-cell biopsy from an embryo with 20% aneuploidy and low or high dispersal?

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classes for embryos with 20% aneuploidy (low level) with A) low and B) high dispersal demonstrate the difference in accuracy from changing dispersal. In this case, higher dispersal yields a higher accuracy." }

e = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.2,
                           dispersal = 0,
                           concordance = 1, rng.seed = 44)
b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)


e2 = tessera::Embryo(n.cells = 200,
                           prop.aneuploid = 0.2,
                           dispersal = 1,
                           concordance = 1, rng.seed = 44)
b2 = tessera::takeAllBiopsies(e2, biopsy.size = 5, chromosome = 1)


plot.pgdis(b, 5) + plot.pgdis(b2, 5) + plot_annotation(tag_levels = c("A"))

```

We see that dispersal has a significant impact on biopsy results, with dispersed aneuploid cells more likely to be classified accurately. The full range of dispersals for an embryo with 20% aneuploidy is as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap= paste("PGDIS classification accuracy by dispersion level. Error bars show standard deviation across", n.replicates, "replicates") }

combinations = expand.grid(dispersals = seq(0.0, 1, 0.05),
                             seeds = 1:n.replicates)
  
result = do.call(rbind, mcmapply(function(dispersal, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = 0.2,
                      dispersal = dispersal,
                      concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  
  cbind(dispersal = rep(dispersal, length(b)), 
        accuracy = pgdis.accuracy(b, 5, 20))
}, mc.cores = n.cores,
dispersal = combinations$dispersals, seed = combinations$seeds,
SIMPLIFY = F)) %>% 
  as.data.frame %>%
  dplyr::group_by(dispersal) %>%
  dplyr::summarise(sd = sd(accuracy), accuracy = mean(accuracy) )


ggplot(result, aes(x = dispersal, y = accuracy)) +
  geom_col() + 
  geom_errorbar(ymin = result$accuracy - result$sd, 
                ymax = result$accuracy + result$sd,
                width = 0.02) +
  labs(x = "Dispersal of aneuploid cells",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 1, 0.1)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  coord_cartesian(ylim = c(0, 100)) +
  theme_classic()

```

Interestingly, the interaction between aneuploidy level and dispersal reveals that PGDIS classification accuracy is dramatically affected by low dispersal, but only for intermediate levels of aneuploidy.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="PGDIS classification accuracy by aneuploidy and dispersion level" }

combinations = expand.grid(aneuploidies = seq(0, 1, 0.1),
                           dispersals   = seq(0, 1, 0.1),
                           seeds        = 1:n.replicates)

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal, seed){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        accuracy   = pgdis.accuracy(b, 5, aneuploidy * 100))
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
seed       = combinations$seeds,
SIMPLIFY = F)) %>% 
  as.data.frame %>%
  dplyr::group_by(aneuploidy, dispersal) %>%
  dplyr::summarise(sd = sd(accuracy), accuracy = mean(accuracy) )

ggplot(as.data.frame(result), aes(x = aneuploidy*100, y = dispersal, fill = accuracy)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0, 100, 20)) +
  labs(x = "Percent aneuploidy in embryo", 
       y = "Dispersal of aneuploid cells",
       fill = "Percentage\nof accurate\nPGDIS\nclassifications") + 
  scale_x_continuous(breaks = seq(0, 100, 10)) +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  theme_classic()
```

# Changing the biopsy parameters

So far we have varied the parameters of the embryo, keeping the biopsy size constant. What happens if we change the biopsy instead?

## The effect of changing biopsy size

How does the distribution of aneuploid cells in a biopsy change as the size of the biopsy increases? The following animation shows the effect of increasing biopsy size from 1 to 10 cells in an embryo of 200 cells.

```{r, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Biopsy size affects accuracy  (animated gif)"}

e = tessera::Embryo(n.cells = 200, 
                           prop.aneuploid = 0.2, 
                           dispersal = 1, 
                           concordance = 1, rng.seed = 42)


make.biopsy.plot = function(biopsy){
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy, chromosome = 1)
  acc = calculate.difference(b, biopsy, 20)
  p  = plot.biopsy.aneuploidy(b, biopsy, 20)
  p + geom_vline(xintercept = 20) + 
    geom_text(x=75, y=95, label=paste(biopsy, "cell biopsy:\n", 
                                        sprintf(acc[['mean']], fmt = '%#.2f'), 
                                        "mean percent difference\nSD:", 
                                      sprintf(acc[["sd"]], fmt = '%#.2f'), "%")) +
    coord_cartesian(xlim = c(0, 100), ylim = c(0, 100))
  
}

invisible(animation::saveGIF(
  expr = { for(i in 1:10) plot(make.biopsy.plot(i)) },
  ani.width = 720, ani.height = 480,
  movie.name = "Biopsy_size.gif"
))
knitr::include_graphics("Biopsy_size.gif")
```


Converting the absolute number of cells into a fraction of the embryo size, we get the following:

```{r, eval=T, echo=FALSE, cache=T, fig.show='hold', fig.cap="Biopsy size does not drastically affect the accuracy of the biopsy beyond about 5% of the embryo"}

combinations = expand.grid(samples = seq(3, 31, 1),
                           seeds   = 1:n.replicates)

result = do.call(rbind, mcmapply(function(biopsy.size, seed){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = 0.2,
                             dispersal = 1,
                             concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
  acc = calculate.difference(b, biopsy.size, 20)
  
  cbind(anuploidy = rep(biopsy.size, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, 
biopsy.size = combinations$samples,
seed        = combinations$seeds,
mc.cores = n.cores, SIMPLIFY = F))

plot.step(result, "Biopsy size", combinations$samples)


```

We can focus on just two biopsy sizes, 5 cells and 10 cells:

```{r, eval=T, echo=FALSE, cache=T, fig.show='hold', fig.cap="Changing biopsy size from 5 to 10 cells does not dramatically improve accuracy"}

# Filter to just 5 and 10 cell biopsies in 200 cell embryo
# Note that the biopsy size is in the column called aneuploidy
# for compatibility with plot.step

filt = result[result[,1]==5 | result[,1]==10,]
plot.step(filt, "Biopsy size", c(5, 10))

```

It appears that there is little benefit to increasing the biopsy size to more than ~5% of the embryo size. The chart above is from an embryo with 200 cells and 20% aneuploidy, highly dispersed. How does the accuracy vary as embryo size changes from 100-300 cells?
 
```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Sampling more than 5% of the embryo is not more informative regardless of embryo size  (animated gif)"}

embryo.sizes = seq(100, 300, 20)

make.biopsy.size.plot = function(embryo.size){
  
  combinations = expand.grid(biopsy.fractions = seq(0.005, 0.15, 0.005),
                             seeds   = 1:n.replicates)

  result = do.call(rbind, mcmapply(function(biopsy.fraction, seed){
    # Constrain biopsy to between 1 and embryo size
    biopsy.size = round(min(max(1, biopsy.fraction * embryo.size), embryo.size))

    # Make embryo of the desired size
    e = tessera::Embryo(n.cells = embryo.size,
                               prop.aneuploid = 0.2,
                               dispersal = 1,
                               concordance = 1, rng.seed = seed)
    b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
    acc = calculate.difference(b, biopsy.size, 20)

    cbind(fraction = rep(biopsy.fraction, length(acc[["values"]])), 
        accuracy = acc[["values"]])
  }, 
  biopsy.fraction = combinations$biopsy.fractions,
  seed = combinations$seeds,
  mc.cores = n.cores, SIMPLIFY = F))
  
  plot.step(result, "Biopsy fraction", combinations$biopsy.fractions) + 
    geom_text(x = 75, y = 75, 
              label = paste("Embryo:", embryo.size, "cells"), 
              col = "black")
}

invisible(animation::saveGIF(
  expr = {
    for(i in embryo.sizes) plot(make.biopsy.size.plot(i))
  },
  ani.width = 720, ani.height = 480,
  movie.name = "Embryo_size_v_biopsy_size.gif"
))
knitr::include_graphics("Embryo_size_v_biopsy_size.gif")

```

It is clear that the overall size of the embryo has little effect compared to the biopsy size, and as we saw above there are few benefits to increasing biopsy size to more than 5-10 cells.

## Biopsy size with respect to PGDIS classification thresholds

We can now explore the impact of biopsy size on the PGDIS classifictions. We start by looking at a 200 cell embryo with 20% aneuploidy and high dispersal.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap=paste("Biopsy size affects the accuracy of PGDIS classification. Error bars show standard deviation across", n.replicates, "replicates")}


combinations = expand.grid(biopsy.sizes = seq(3, 50, 1),
                             seeds   = 1:n.replicates)

result = do.call(rbind, mcmapply(function(biopsy.size, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = 0.2,
                      dispersal = 1,
                      concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1)
  
  
  
  cbind(biopsy.size = rep(biopsy.size, length(b)), 
        accuracy = pgdis.accuracy(b, biopsy.size, 20))
}, 
biopsy.size = combinations$biopsy.sizes,
seed = combinations$seeds,
mc.cores = n.cores, SIMPLIFY = F)) %>% 
  as.data.frame %>%
  dplyr::group_by(biopsy.size) %>%
  dplyr::summarise(sd = sd(accuracy), accuracy = mean(accuracy) )

ggplot(result, aes(x = biopsy.size, y = accuracy)) +
  geom_col() + 
  geom_errorbar(ymin = result$accuracy - result$sd, 
                ymax = result$accuracy + result$sd,
                width = 0.4) +
  labs(x = "Size of biopsy",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 50, 5)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  coord_cartesian(ylim = c(0, 100)) +
  theme_classic()

```

These data are noisy, with a repeating pattern every 5 cells due to the hard boundaries of the PGDIS classifiation scheme. We see though that there is little to no benefit in sampling more than 5-10 cells from an embryo.

## Variability in embryo and biopsy size

So far we have been using embryos and biopsies with exact sizes. In reality, there may be variation - the size of an embryo may be estimated inexactly, and a biopsy may contain +/- a cell, due to the difficulties in taking biopsies. We can add some of this uncertainty to the model by allowing our embryo and biopsy sizes to vary from their target under a normal distribution.


```{r, eval=T, echo=FALSE, cache=T, fig.show='hold', fig.cap="Biopsy size does not drastically affect the accuracy of the biopsy beyond about 5% of the embryo"}

combinations = expand.grid(samples = seq(3, 31, 1),
                           seeds   = 1:n.replicates)

result = do.call(rbind, mcmapply(function(biopsy.size, seed){

  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = 0.2,
                      dispersal = 1,
                      concordance = 1, 
                      rng.seed = seed,
                      embryo.size.fixed = F,
                      embryo.size.sd = 5)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1,
                               biopsy.size.fixed = F, biopsy.size.sd = 1)
  acc = calculate.difference(b, biopsy.size, 20)
  
  cbind(anuploidy = rep(biopsy.size, length(acc[["values"]])), 
        accuracy = acc[["values"]])
}, 
biopsy.size = combinations$samples,
seed        = combinations$seeds,
mc.cores = n.cores, SIMPLIFY = F))

plot.step(result, "Biopsy size", combinations$samples)

```

It is apparent that there is little overall difference when allowing some variation in embryo and biopsy size. We can confirm this in relation to PGDIS classification:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap=paste("Biopsy and embryo size variation does not greatly affect the model results with a biopsy sd of 1. Error bars show standard deviation across", n.replicates, "replicates")}
combinations = expand.grid(biopsy.sizes = seq(3, 50, 1),
                           seeds   = 1:n.replicates)

result = do.call(rbind, mcmapply(function(biopsy.size, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = 0.2,
                      dispersal = 1,
                      concordance = 1, rng.seed = seed,
                      embryo.size.fixed = F,
                      embryo.size.sd = 5)
  b = tessera::takeAllBiopsies(e, biopsy.size = biopsy.size, chromosome = 1,
                               biopsy.size.fixed = F, biopsy.size.sd = 1)
 
  cbind(biopsy.size = rep(biopsy.size, length(b)), 
        accuracy = pgdis.accuracy(b, biopsy.size, 20))
}, 
biopsy.size = combinations$biopsy.sizes,
seed = combinations$seeds,
mc.cores = n.cores, SIMPLIFY = F)) %>% 
  as.data.frame %>%
  dplyr::group_by(biopsy.size) %>%
  dplyr::summarise(sd = sd(accuracy), accuracy = mean(accuracy) )

ggplot(result, aes(x = biopsy.size, y = accuracy)) +
  geom_col() + 
  geom_errorbar(ymin = result$accuracy - result$sd, 
                ymax = result$accuracy + result$sd,
                width = 0.4) +
  labs(x = "Size of biopsy",
       y = "Percent of biopsies in correct PGDIS class") + 
  scale_x_continuous(breaks = seq(0, 50, 5)) +
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  coord_cartesian(ylim = c(0, 100)) +
  theme_classic()

```

# What does a biopsy tell us?

From the previous sections, we have seen that the parameters of the toy embryo and the biopsy affect how well the biopsy represents the embryo. Now, we shall consider what we can conclude from a given biopsy. We will assume that both the size of the embryo and the size of the biopsy are known, and we do not know the aneuploidy level or the dispersion of the aneuploid cells. If we are given a biopsy, what range of embryo parameters are compatible?

## Predicting an embryo state from a biopsy

We return to a fixed biopsy size of 5 cells. This biopsy has a single aneuploid cell, a rate of 20%. We know the embryo has 200 cells. What are the possible parameters for aneuploidy and dispersal?


```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T}

combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05),
                           seeds   = 1:n.replicates)

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal, seed){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
seed       = combinations$seeds,
SIMPLIFY = F))



# Determine the proportion of conditions with the same outcome as our test biopsy
output.aneuploidy = as.data.frame(result) %>%
  dplyr::group_by(n.aneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = dplyr::n())
  
# this gives us the overall accuracy: we will accuratly assess the aneuploidy level
# in x percent of biopsies:
overall.accuracy.0 = sum(output.aneuploidy[output.aneuploidy$n.aneuploid==1,]$Count)/nrow(result)*100

```

If we define `r nrow(combinations)` embryos with `r n.replicates` replicates of distinct combinations of aneuploidy (`r length(unique(combinations$aneuploidies))` steps from 0-1) and dispersal (`r length(unique(combinations$dispersals))` steps from 0-1), we can take `r nrow(result)` possible biopsies across the resulting embryos. Our biopsy has 1 aneuploid cell; this pattern is seen in `r sprintf(overall.accuracy.0, fmt = '%#.2f')`% of the total biopsies:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height=3, fig.width=4, fig.cap="Number of biopsies across all embryos with aneuploid cells. A biopsy with 1 aneuploid cell can come from a range of possible embryos."}

ggplot(as.data.frame(result), aes(x = n.aneuploid, fill = n.aneuploid==1)) + 
  geom_bar() + 
  labs(x = "Number of aneuploid cells in biopsy",
       y = "Number of possible biopsies\nfrom all embryo combinations") + 
  scale_x_continuous(breaks = seq(0, 5, 1)) +
  scale_fill_manual(values = c("grey", "dark green")) + 
  theme_classic() + 
  theme(legend.position = "none")

```

We can now look at the possible embryos that could yield this biopsy. The biopsies with a single aneuploid cell come from embryos with the following parameters:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Possible embryo parameters matching a biopsy with one aneuploid cell"}

zero.data = expand.grid(aneuploidy = unique(combinations$aneuploidies),
                          dispersal  = unique(combinations$dispersals),
                          n.aneuploid = 0:5,
                          Count = 0)

matching.biopsies = suppressMessages(output.aneuploidy %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(aneuploidy, dispersal, n.aneuploid) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(n.aneuploid) %>%
  dplyr::mutate(Total = sum(Count)) %>%
  dplyr::mutate(Pct = Count / Total * 100))

ggplot(matching.biopsies %>% dplyr::filter(n.aneuploid==1), aes(x=aneuploidy, y=dispersal, fill=Pct)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0.1, 1.1, 0.2)) +
  labs(x = "Aneuploidy", 
       y = "Dispersal",
       fill = "Percentage\nof biopsies") + 
  theme_classic()

```

We see that while a biopsy like this most probably comes from an embryo with ~20% aneuploidy and high dispersal, there is a wide range of possibilities. A similar probability space can be created for any number of observed aneuploid cells:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="The probability space of 5-cell biopsies for a 200 cell embryo"}

ggplot(matching.biopsies, aes(x=aneuploidy, y=dispersal, fill=Pct)) +
  geom_tile() +
  scale_fill_viridis_c(breaks = seq(0.1, 1.1, 0.2)) +
  labs(x = "Aneuploidy", 
       y = "Dispersal",
       fill = "Percentage\nof biopsies") + 
  theme_classic() +
  facet_wrap(~n.aneuploid)

```

As noted above, we see that the dispersal of cells only becomes relevant at low levels; above 25% dispersal, the results are broadly similar. However, the distribution of possible embryos for a given biopsy is extremely broad, suggesting there is great difficultly relating a biopsy result back to an embryo unless the biopsy is entirely euploid or aneuploid.

## Predicting PGDIS classifiction from a biopsy

From the above, we can now determine the percentage of PGDIS classes that a given biopsy could originate from. We see that there is a less than 50% chance that the biopsy came from a low level embryo, and about a 25% chance each that the embryo came from a euploid or high level embryo. If we predicted the embryo was low level aneuploid from this biopsy, we would be wrong more than half the time.

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Liklihood of each PGDIS class producing a 5-cell biopsy with a single aneuploid cell", fig.height= 3, fig.width=3 }


combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05),
                           seeds        = 1)

# The possible outcomes from all combinations of embryo parameters
result = do.call(rbind, mcmapply(function(aneuploidy, dispersal, seed){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
seed       = combinations$seeds,
SIMPLIFY = F)) %>% as.data.frame %>%
  dplyr::mutate(PctBiopsyAneuploid = n.aneuploid / 5 * 100,
                EmbryoClass = factor(sapply(aneuploidy*100, to.pgdis.class), 
                            levels = pgdis.classes),
                BiopsyClass = factor(sapply(n.aneuploid /5 *100, to.pgdis.class), 
                            levels = pgdis.classes))

# result$PctBiopsyAneuploid = result$n.aneuploid / 5 * 100
# result$EmbryoClass = factor(sapply(result$aneuploidy*100, to.pgdis.class), 
#                             levels = pgdis.classes)


# Now take the biopsies with a single aneuploid cell

# Determine the proportion of conditions with the same outcome as our test biopsy
output.aneuploidy = result %>%
  dplyr::group_by(n.aneuploid, EmbryoClass, BiopsyClass) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(n.aneuploid) %>%
  dplyr::mutate(Total = sum(Count)) %>%
  dplyr::mutate(PctTotal = Count / Total * 100)
  
ggplot(output.aneuploidy%>%dplyr::filter(n.aneuploid==1), aes(x = EmbryoClass, y = PctTotal, fill = EmbryoClass==BiopsyClass)) + 
  geom_col() + 
  geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.2f'), y = PctTotal-5), col="white") + 
  labs(y = "Percent of biopsies") +
  scale_fill_manual(values = c("dark grey", "dark green")) + 
  coord_cartesian(ylim = c(0, 50)) + 
  scale_y_continuous(breaks = seq(0, 100, 10)) +
  theme_classic() + 
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "none")
```

We can also show the probability of origins for biopsies for the full range of 0-5 aneuploid cells:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.cap="Liklihood of each PGDIS class producing a 5-cell biopsy with a given number of aneuploid cells. The matching embryo class for the biopsy is highlighted, demonstrating that between 1 to 4 aneuploid cells, few biopsies come from embryos of the same PGDIS class", fig.height=7 }

ggplot(output.aneuploidy, aes(x = EmbryoClass, y = PctTotal, fill = EmbryoClass==BiopsyClass)) + 
  geom_col() + 
  geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.2f'), y = PctTotal-5), col = "white") + 
  labs(y = "Percent of biopsies from this class") +
  scale_fill_manual(values = c("dark grey", "dark green")) + 
  coord_cartesian(ylim = c(0, 100)) + 
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  facet_wrap(~n.aneuploid, ncol = 2) + 
  theme_classic() + 
  theme(axis.title.x = element_blank()) + 
  theme(legend.position = "none")
```

We can conclude from this that there are limitations to the usefulness of biopsies unless they are fully euploid or fully aneuploid. This can be visualised more clearly as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="Confidently relating biopsy aneuploidy to embryo aneuploidy is only possible if dispersal is high. White boxes show PGDIS classification boundaries." }

zero.data = expand.grid(aneuploidy = seq(0, 1, 0.05),
                        PctBiopsyAneuploid  = seq(0, 100, 20),
                        Count = 0,
                        dispersal = seq(0, 1, 0.05))

clumpy.embryos.1x5 = result %>% 
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, dispersal) %>%
  dplyr::mutate(CountBiopsy = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::mutate(PctTotal = Count/CountBiopsy * 100) %>%
  dplyr::filter(dispersal %in% c(0, 0.5, 1))

ggplot(clumpy.embryos.1x5, aes(x = PctBiopsyAneuploid, y = aneuploidy, fill=PctTotal))+
  geom_tile() +
  # geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.0f')))+
  geom_rect(xmin=-10, xmax=10, ymin=-0.025, ymax=0.175, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=10, xmax=30, ymin=0.175, ymax=0.375, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=30, xmax=70, ymin=0.375, ymax=0.775, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=70, xmax=110, ymin=0.775, ymax=1.025, 
            fill=NA, col="white", size=1)+
  scale_fill_viridis_c(breaks = seq(0, 30, 5)) +
  labs(x = "Biopsy aneuploidy",
       y = "Embryo aneuploidy",
       fill = "Percentage\nof biopsies") +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  theme_classic() + 
  facet_wrap(~dispersal)
  
```

White boxes show the PGDIS class boundaries. When aneuploid cells are dispersed, there is a clear correlation between the aneuploidy in the biopsy and the aneuploidy in the embryo. However, if aneuploid cells are clustered, the correlation is much weaker, and we cannot infer the embryo aneuploidy except in cases when there is 0% or 100% biopsy aneuploidy.

This becomes more evident if we consider the impact on PGDIS classification success from a biopsy result:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="PGDIS classes cannot be inferred from biopsy results" }

pgdis.totals.1x5 = clumpy.embryos.1x5 %>%
  dplyr::mutate(EmbryoClass = to.pgdis.class(aneuploidy*100)) %>%
  dplyr::mutate(EmbryoClass = factor(EmbryoClass, levels = pgdis.classes)) %>%
  dplyr::group_by(PctBiopsyAneuploid, EmbryoClass, dispersal) %>%
  dplyr::summarise(Total = sum(PctTotal)) %>%
  dplyr::mutate(BiopsyClass = to.pgdis.class(PctBiopsyAneuploid)) %>%
  dplyr::mutate(BiopsyClass = factor(BiopsyClass, levels = pgdis.classes)) %>%
  dplyr::mutate(IsCorrect = EmbryoClass==BiopsyClass)

ggplot(pgdis.totals.1x5, aes(x = PctBiopsyAneuploid, y= Total,  fill=IsCorrect))+
  geom_hline(yintercept = 50) +
  geom_col(position="stack") +
  scale_fill_manual(values = c("grey", "dark green")) +
  # scale_colour_viridis_d()+
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  labs(y = "Percentage of embryos\nmatching biopsy class",
       x = "Biopsy aneuploidy") +
  facet_wrap(~dispersal) +
  theme_classic() +
  theme(legend.position = "none")
```


# Does taking two biopsies help?

We have seen that biopsies are not informative except when they are entirely euploid or aneuploid. We have also seen that increasing the biopsy size from 5 cells to 10 cells provides little extra information. What if we instead take two separate 5-cell biopsies, from different regions of the embryo? Does this provide us with better information?

We start with an embryo with 20% aneuploidy with no dispersal. The 1x5 biopsy results are above in section 4. We can generate equivalent results for a 1x10 biopsy:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="Biopsy aneuploidy correlation with embryo for 1x10 biopsies" }
combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05),
                           seeds        = 1:n.replicates)

# The possible outcomes from all combinations of embryo parameters
result.1x10 = do.call(rbind, mcmapply(function(aneuploidy, dispersal, seed){
  
  e = tessera::Embryo(n.cells = 200,
                      prop.aneuploid = aneuploidy,
                      dispersal = dispersal,
                      concordance = 1, rng.seed = seed)
  b = tessera::takeAllBiopsies(e, biopsy.size = 10, chromosome = 1)
  
  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
seed       = combinations$seeds,
SIMPLIFY = F)) %>% as.data.frame %>%
  dplyr::mutate(PctBiopsyAneuploid = n.aneuploid / 10 * 100)

zero.data = expand.grid(aneuploidy          = seq(0, 1, 0.05),
                        dispersal           = seq(0, 1, 0.05),
                        PctBiopsyAneuploid  = seq(0, 100, 10),
                        Count = 0)

clumpy.embryos.1x10 = result.1x10 %>% 
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, dispersal) %>%
  dplyr::mutate(CountBiopsy = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::mutate(PctTotal = Count/CountBiopsy * 100) %>%
  dplyr::filter(dispersal %in% c(0, 0.5, 1))

ggplot(clumpy.embryos.1x10, aes(x = PctBiopsyAneuploid, y = aneuploidy, fill=PctTotal))+
  geom_tile() +
  # geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.0f')))+
  geom_rect(xmin=-5, xmax=15, ymin=-0.025, ymax=0.175, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=15, xmax=35, ymin=0.175, ymax=0.375, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=35, xmax=75, ymin=0.375, ymax=0.775, 
            fill=NA, col="white", size=1)+
  geom_rect(xmin=75, xmax=105, ymin=0.775, ymax=1.025, 
            fill=NA, col="white", size=1)+
  scale_fill_viridis_c(breaks = seq(0, 60, 5)) +
  labs(x = "Biopsy aneuploidy",
       y = "Embryo aneuploidy",
       fill = "Percentage\nof biopsies") +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  theme_classic() + 
  facet_wrap(~dispersal)

```

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="Correct PGDIS classes from 1x10 biopsy results" }

pgdis.totals.1x10 = clumpy.embryos.1x10 %>%
  dplyr::mutate(EmbryoClass = to.pgdis.class(aneuploidy*100)) %>%
  dplyr::mutate(EmbryoClass = factor(EmbryoClass, levels = pgdis.classes)) %>%
  dplyr::group_by(PctBiopsyAneuploid, EmbryoClass, dispersal) %>%
  dplyr::summarise(Total = sum(PctTotal)) %>%
  dplyr::mutate(BiopsyClass = to.pgdis.class(PctBiopsyAneuploid)) %>%
  dplyr::mutate(BiopsyClass = factor(BiopsyClass, levels = pgdis.classes)) %>%
  dplyr::mutate(IsCorrect = EmbryoClass==BiopsyClass)

ggplot(pgdis.totals.1x10, aes(x = PctBiopsyAneuploid, y= Total,  fill=IsCorrect))+
  geom_hline(yintercept = 50) +
  geom_col(position="stack") +
  scale_fill_manual(values = c("grey", "dark green")) +
  # scale_colour_viridis_d()+
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  labs(y = "Percentage of embryos\nmatching biopsy class",
       x = "Biopsy aneuploidy") +
  facet_wrap(~dispersal) +
  theme_classic() +
  theme(legend.position = "none")
```

Now let's take all possible combinations of two 5 cell biopsies, and average their results.


```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="Taking two five cell biopsies does not improve greatly over one 10 cell biopsy"}


e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = 0.2,
                             dispersal = 0,
                             concordance = 1, rng.seed = 44)
b = tessera::takeAllBiopsies(e, biopsy.size = 5, chromosome = 1)


take.two.biopsies = function(embryo, biopsy.size, chromosome){
  
  getNeighboursToExclude = function(embryo, cell.index){
    # get the direct neighbours - these will be in the biopsy
    neighbours = tessera::getNeighbouringCellIndexes(embryo, cell.index)
    
    # Get neighbours of neighbours so we don't have any surrounding biopsies 
    # including the missing cells
    neighbours2 = sapply(neighbours, tessera::getNeighbouringCellIndexes, embryo=e)
    return(unique(c(cell.index, neighbours, neighbours2)))
  }
  
  result = c()
  
  for(i in 1:length(embryo)){
    # cat("cell ", i, "\n")
    # First biopsy can be from any cell
    b1 = tessera::takeBiopsy(embryo, biopsy.size = biopsy.size, chromosome = chromosome, index.cell = i)
    
    # We now need to exclude neighbouring cells for second biopsy
    exclude.list = getNeighboursToExclude(e, i)
    
    # all cells
    all.cells = 1:length(embryo)
    
    keep.list = all.cells[! all.cells %in% exclude.list]
    
    for(j in keep.list){
      # Get all possible second biopsies
      # Take average and concatenate to result
      result = c(result, (b1 + tessera::takeBiopsy(embryo, biopsy.size = biopsy.size, chromosome = chromosome, index.cell = j)/2 ) )
    }
  }
  return(result)
}

b.2x5 = take.two.biopsies(e, biopsy.size = 5, chromosome = 1)


# compare to the 10 cell biopsies from the same embryo
b10 = tessera::takeAllBiopsies(e, biopsy.size = 10, chromosome = 1)

# p3 = plot.pgdis(b, 5) + labs(title = "1x5 cell")

# Get all pairwise combinations of biopsy result
# p4 = plot.pgdis(b.2x5, 5) + labs(title = "2x5 cell")
# pgdis.accuracy(b.2x5, 5, 20)

# p5 = plot.pgdis(b10, 10) + labs(title = "1x10 cell")
# pgdis.accuracy(b10, 10, 20)

# p3 + p5 +p4


# At a first approximation, two 5 cell biopsies appear to offer a slight improvement over a single 10 cell biopsy. The correct PGDIS classification (low level) is assigned in `r pgdis.accuracy(g$Avg, 5, 20)`% of 2x5 biopsies rather than `r pgdis.accuracy(b10, 10, 20)`% in a 10-cell biopsy and `r pgdis.accuracy(b, 5, 20)`% in a single 5-cell biopsy. We note however that this despite this increase the overall accuracy remains low.


```


Let's compare the correlation of biopsy aneuploidy with embryo aneuploidy under a 2x5 cell model.


```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height= 3, fig.cap="2x5 biopsies do not overcome the issues in interpreting biopsy aneuploidy "}
combinations = expand.grid(aneuploidies = seq(0, 1, 0.05),
                           dispersals   = seq(0, 1, 0.05),
                           seeds        = 42) # this takes too long

# The possible outcomes from all combinations of embryo parameters
result.2x5 = do.call(rbind, mcmapply(function(aneuploidy, dispersal, seed){

  e = tessera::Embryo(n.cells = 200,
                             prop.aneuploid = aneuploidy,
                             dispersal = dispersal,
                             concordance = 1, rng.seed = seed)
  b = take.two.biopsies(e, biopsy.size = 5, chromosome = 1)

  cbind(aneuploidy = rep(aneuploidy, length(b)),
        dispersal  = rep(dispersal, length(b)),
        n.aneuploid = b)
}, mc.cores = n.cores,
aneuploidy = combinations$aneuploidies,
dispersal  = combinations$dispersals,
seed       = combinations$seeds,
SIMPLIFY = F)) %>% as.data.frame %>%
  dplyr::mutate(PctBiopsyAneuploid = n.aneuploid / 5 * 100)


zero.data = expand.grid(aneuploidy = combinations$aneuploidies,
                        dispersal = combinations$dispersals,
                        PctBiopsyAneuploid  = seq(0, 100, 10),
                        Count = 0)

clumpy.embryos.2x5 = result.2x5 %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = dplyr::n()) %>%
  dplyr::bind_rows(., zero.data) %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::summarise(Count = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, dispersal) %>%
  dplyr::mutate(CountBiopsy = sum(Count)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(PctBiopsyAneuploid, aneuploidy, dispersal) %>%
  dplyr::mutate(PctTotal = Count/CountBiopsy * 100) %>%
  dplyr::filter(dispersal %in% c(0, 0.5, 1))

ggplot(clumpy.embryos.2x5, aes(x = PctBiopsyAneuploid, y = aneuploidy, fill=PctTotal))+
  geom_tile() +
  # geom_text(aes(label =  sprintf(PctTotal, fmt = '%#.0f')))+
  geom_rect(xmin=-5, xmax=15, ymin=-0.025, ymax=0.175,
            fill=NA, col="white", size=1)+
  geom_rect(xmin=15, xmax=35, ymin=0.175, ymax=0.375,
            fill=NA, col="white", size=1)+
  geom_rect(xmin=35, xmax=75, ymin=0.375, ymax=0.775,
            fill=NA, col="white", size=1)+
  geom_rect(xmin=75, xmax=105, ymin=0.775, ymax=1.025,
            fill=NA, col="white", size=1)+
  scale_fill_viridis_c(breaks = seq(0, 60, 5)) +
  labs(x = "Biopsy aneuploidy",
       y = "Embryo aneuploidy",
       fill = "Percentage\nof biopsies") +
  scale_y_continuous(breaks = seq(0, 1, 0.1)) +
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  theme_classic() +
  facet_wrap(~dispersal)


```

The impact on PGDIS classifications is as follows:

```{r, eval=T, echo=FALSE, warning=F, message=F, cache=T, fig.show='hold', fig.height=3, fig.cap="PGDIS classes cannot be reliably inferred from biopsy results" }

pgdis.totals.2x5 = clumpy.embryos.2x5 %>%
  dplyr::mutate(EmbryoClass = to.pgdis.class(aneuploidy*100)) %>%
  dplyr::mutate(EmbryoClass = factor(EmbryoClass, levels = pgdis.classes)) %>%
  dplyr::group_by(PctBiopsyAneuploid, EmbryoClass, dispersal) %>%
  dplyr::summarise(Total = sum(PctTotal)) %>%
  dplyr::mutate(BiopsyClass = to.pgdis.class(PctBiopsyAneuploid)) %>%
  dplyr::mutate(BiopsyClass = factor(BiopsyClass, levels = pgdis.classes)) %>%
  dplyr::mutate(IsCorrect = EmbryoClass==BiopsyClass)

ggplot(pgdis.totals.2x5, aes(x = PctBiopsyAneuploid, y= Total,  fill=IsCorrect))+
  geom_hline(yintercept = 50) +
  geom_col(position="stack") +
  scale_fill_manual(values = c("grey", "dark green")) +
  # scale_colour_viridis_d()+
  scale_x_continuous(breaks = seq(0, 100, 20)) +
  scale_y_continuous(breaks = seq(0, 100, 20)) +
  labs(y = "Percentage of embryos matching biopsy class",
       x = "Biopsy aneuploidy") +
  facet_wrap(~dispersal) +
  theme_classic()+
  theme(legend.position = "none")
```

There is an improvement versus a 1x5 biopsy, but not clearly greater than that provided by a 1x10 biopsy, suggesting repeated biopsying is not an effective solution to the mosaicism problem; unless a biopsy is fully euploid or fully aneuploid, we conclude that it should not be considered informative as to the state of the embryo proper.

# Caveats and limitations

This is clearly a simple model using a toy embryo. The predictive power is limited by several factors:

- we assume that all combinations of aneuploidy and dispersal are equally likely. This may not be true of real embryos, and the parameter space may need to be refined
- we assume that the size of the embryo and biopsy are known and fixed. It is possible for a biopsy to contain more or fewer cells than desired, and is can be unclear exactly how many cells the embryo contains
 
 The next question to consider is that of biological relevance; where in the parameter space can embryos actually lie? Do embryos with high dispersal exist, or are they always found with clusters of aneuploidy?
 
 
 It would be expected that dispersal is generally clustered, with aneuploid cells resulting from an initial non-disjunction event. However cases of multiple independent aneuploidies have been noted (e.g. Mendiola et al 2022).
 
# TODO
 
 - develop reverse lookup tool in tessera

